!function(t,e){"object"==typeof exports&&"undefined"!=typeof module?e(exports):"function"==typeof define&&define.amd?define(["exports"],e):e((t="undefined"!=typeof globalThis?globalThis:t||self).Y={})}(this,function(t){"use strict";const e=()=>new Map,n=t=>{const n=e();return t.forEach((t,e)=>{n.set(e,t)}),n},s=(t,e,n)=>{let s=t.get(e);return void 0===s&&t.set(e,s=n()),s},r=()=>new Set,i=t=>t[t.length-1],o=(t,e)=>{for(let n=0;n<e.length;n++)t.push(e[n])},l=Array.from,c=(t,e)=>{for(let n=0;n<t.length;n++)if(!e(t[n],n,t))return!1;return!0},h=(t,e)=>{for(let n=0;n<t.length;n++)if(e(t[n],n,t))return!0;return!1},a=Array.isArray,u=(t,e,n)=>{const s=t[e];let r=e;for(;r+1<t.length&&n(s,t[r+1])>0;)t[r]=t[r+1],t[++r]=s;if(e===r&&r>0)for(;r>0&&n(t[r-1],s)>0;)t[r]=t[r-1],t[--r]=s;return r};class d{constructor(){this._observers=e()}on(t,e){return s(this._observers,t,r).add(e),e}once(t,e){const n=(...s)=>{this.off(t,n),e(...s)};this.on(t,n)}off(t,e){const n=this._observers.get(t);void 0!==n&&(n.delete(e),0===n.size&&this._observers.delete(t))}emit(t,n){return l((this._observers.get(t)||e()).values()).forEach(t=>t(...n))}destroy(){this._observers=e()}}const g=Math.floor,f=Math.abs,p=(t,e)=>t<e?t:e,k=(t,e)=>t>e?t:e,w=t=>0!==t?t<0:1/t<0,m=64,y=128,b=127,_=Number.MAX_SAFE_INTEGER,S=Number.isInteger||(t=>"number"==typeof t&&isFinite(t)&&g(t)===t),C=String.fromCharCode,v=/^\s*/g,E=/([A-Z])/g,D=(t,e)=>(t=>t.replace(v,""))(t.replace(E,t=>`${e}${(t=>t.toLowerCase())(t)}`)),I="undefined"!=typeof TextEncoder?new TextEncoder:null,A=I?t=>I.encode(t):t=>{const e=unescape(encodeURIComponent(t)),n=e.length,s=new Uint8Array(n);for(let t=0;t<n;t++)s[t]=e.codePointAt(t);return s};let x="undefined"==typeof TextDecoder?null:new TextDecoder("utf-8",{fatal:!0,ignoreBOM:!0});x&&1===x.decode(new Uint8Array).length&&(x=null);const L=(t,e)=>((t,e)=>{const n=new Array(t);for(let s=0;s<t;s++)n[s]=e(s,n);return n})(e,()=>t).join("");class O{constructor(){this.cpos=0,this.cbuf=new Uint8Array(100),this.bufs=[]}}const U=()=>new O,M=t=>{const e=U();return t(e),T(e)},T=t=>{const e=new Uint8Array((t=>{let e=t.cpos;for(let n=0;n<t.bufs.length;n++)e+=t.bufs[n].length;return e})(t));let n=0;for(let s=0;s<t.bufs.length;s++){const r=t.bufs[s];e.set(r,n),n+=r.length}return e.set(new Uint8Array(t.cbuf.buffer,0,t.cpos),n),e},N=(t,e)=>{const n=t.cbuf.length;t.cpos===n&&(t.bufs.push(t.cbuf),t.cbuf=new Uint8Array(2*n),t.cpos=0),t.cbuf[t.cpos++]=e},R=N,V=(t,e)=>{for(;e>b;)N(t,y|b&e),e=g(e/128);N(t,b&e)},F=(t,e)=>{const n=w(e);for(n&&(e=-e),N(t,(e>63?y:0)|(n?m:0)|63&e),e=g(e/64);e>0;)N(t,(e>b?y:0)|b&e),e=g(e/128)},P=new Uint8Array(3e4),j=P.length/3,J=I&&I.encodeInto?(t,e)=>{if(e.length<j){const n=I.encodeInto(e,P).written||0;V(t,n);for(let e=0;e<n;e++)N(t,P[e])}else B(t,A(e))}:(t,e)=>{const n=unescape(encodeURIComponent(e)),s=n.length;V(t,s);for(let e=0;e<s;e++)N(t,n.codePointAt(e))},z=(t,e)=>{const n=t.cbuf.length,s=t.cpos,r=p(n-s,e.length),i=e.length-r;t.cbuf.set(e.subarray(0,r),s),t.cpos+=r,i>0&&(t.bufs.push(t.cbuf),t.cbuf=new Uint8Array(k(2*n,i)),t.cbuf.set(e.subarray(r)),t.cpos=i)},B=(t,e)=>{V(t,e.byteLength),z(t,e)},H=(t,e)=>{((t,e)=>{const n=t.cbuf.length;n-t.cpos<e&&(t.bufs.push(new Uint8Array(t.cbuf.buffer,0,t.cpos)),t.cbuf=new Uint8Array(2*k(n,e)),t.cpos=0)})(t,e);const n=new DataView(t.cbuf.buffer,t.cpos,e);return t.cpos+=e,n},$=new DataView(new ArrayBuffer(4)),W=(t,e)=>{switch(typeof e){case"string":N(t,119),J(t,e);break;case"number":S(e)&&f(e)<=2147483647?(N(t,125),F(t,e)):(n=e,$.setFloat32(0,n),$.getFloat32(0)===n?(N(t,124),((t,e)=>{H(t,4).setFloat32(0,e,!1)})(t,e)):(N(t,123),((t,e)=>{H(t,8).setFloat64(0,e,!1)})(t,e)));break;case"bigint":N(t,122),((t,e)=>{H(t,8).setBigInt64(0,e,!1)})(t,e);break;case"object":if(null===e)N(t,126);else if(a(e)){N(t,117),V(t,e.length);for(let n=0;n<e.length;n++)W(t,e[n])}else if(e instanceof Uint8Array)N(t,116),B(t,e);else{N(t,118);const n=Object.keys(e);V(t,n.length);for(let s=0;s<n.length;s++){const r=n[s];J(t,r),W(t,e[r])}}break;case"boolean":N(t,e?120:121);break;default:N(t,127)}var n};class K extends O{constructor(t){super(),this.w=t,this.s=null,this.count=0}write(t){this.s===t?this.count++:(this.count>0&&V(this,this.count-1),this.count=1,this.w(this,t),this.s=t)}}const Y=t=>{t.count>0&&(F(t.encoder,1===t.count?t.s:-t.s),t.count>1&&V(t.encoder,t.count-2))};class G{constructor(){this.encoder=new O,this.s=0,this.count=0}write(t){this.s===t?this.count++:(Y(this),this.count=1,this.s=t)}toUint8Array(){return Y(this),T(this.encoder)}}const X=t=>{if(t.count>0){const e=2*t.diff+(1===t.count?0:1);F(t.encoder,e),t.count>1&&V(t.encoder,t.count-2)}};class q{constructor(){this.encoder=new O,this.s=0,this.count=0,this.diff=0}write(t){this.diff===t-this.s?(this.s=t,this.count++):(X(this),this.count=1,this.diff=t-this.s,this.s=t)}toUint8Array(){return X(this),T(this.encoder)}}class Z{constructor(){this.sarr=[],this.s="",this.lensE=new G}write(t){this.s+=t,this.s.length>19&&(this.sarr.push(this.s),this.s=""),this.lensE.write(t.length)}toUint8Array(){const t=new O;return this.sarr.push(this.s),this.s="",J(t,this.sarr.join("")),z(t,this.lensE.toUint8Array()),T(t)}}const Q=t=>new Error(t),tt=()=>{throw Q("Method unimplemented")},et=()=>{throw Q("Unexpected case")},nt=Q("Unexpected end of array"),st=Q("Integer out of Range");class rt{constructor(t){this.arr=t,this.pos=0}}const it=t=>new rt(t),ot=t=>t.pos!==t.arr.length,lt=t=>((t,e)=>{const n=new Uint8Array(t.arr.buffer,t.pos+t.arr.byteOffset,e);return t.pos+=e,n})(t,ht(t)),ct=t=>t.arr[t.pos++],ht=t=>{let e=0,n=1;const s=t.arr.length;for(;t.pos<s;){const s=t.arr[t.pos++];if(e+=(s&b)*n,n*=128,s<y)return e;if(e>_)throw st}throw nt},at=t=>{let e=t.arr[t.pos++],n=63&e,s=64;const r=(e&m)>0?-1:1;if(0===(e&y))return r*n;const i=t.arr.length;for(;t.pos<i;){if(e=t.arr[t.pos++],n+=(e&b)*s,s*=128,e<y)return r*n;if(n>_)throw st}throw nt},ut=x?t=>x.decode(lt(t)):t=>{let e=ht(t);if(0===e)return"";{let n=String.fromCodePoint(ct(t));if(--e<100)for(;e--;)n+=String.fromCodePoint(ct(t));else for(;e>0;){const s=e<1e4?e:1e4,r=t.arr.subarray(t.pos,t.pos+s);t.pos+=s,n+=String.fromCodePoint.apply(null,r),e-=s}return decodeURIComponent(escape(n))}},dt=(t,e)=>{const n=new DataView(t.arr.buffer,t.arr.byteOffset+t.pos,e);return t.pos+=e,n},gt=[t=>{},t=>null,at,t=>dt(t,4).getFloat32(0,!1),t=>dt(t,8).getFloat64(0,!1),t=>dt(t,8).getBigInt64(0,!1),t=>!1,t=>!0,ut,t=>{const e=ht(t),n={};for(let s=0;s<e;s++){n[ut(t)]=ft(t)}return n},t=>{const e=ht(t),n=[];for(let s=0;s<e;s++)n.push(ft(t));return n},lt],ft=t=>gt[127-ct(t)](t);class pt extends rt{constructor(t,e){super(t),this.reader=e,this.s=null,this.count=0}read(){return 0===this.count&&(this.s=this.reader(this),ot(this)?this.count=ht(this)+1:this.count=-1),this.count--,this.s}}class kt extends rt{constructor(t){super(t),this.s=0,this.count=0}read(){if(0===this.count){this.s=at(this);const t=w(this.s);this.count=1,t&&(this.s=-this.s,this.count=ht(this)+2)}return this.count--,this.s}}class wt extends rt{constructor(t){super(t),this.s=0,this.count=0,this.diff=0}read(){if(0===this.count){const t=at(this),e=1&t;this.diff=g(t/2),this.count=1,e&&(this.count=ht(this)+2)}return this.s+=this.diff,this.count--,this.s}}class mt{constructor(t){this.decoder=new kt(t),this.str=ut(this.decoder),this.spos=0}read(){const t=this.spos+this.decoder.read(),e=this.str.slice(this.spos,t);return this.spos=t,e}}const yt=Symbol("Equality"),bt=(t,e)=>t===e||t[yt]?.(e)||!1;class _t{constructor(t,e){this.clock=t,this.len=e}copyWith(t,e){return new _t(t,e)}get attrs(){return[]}}class St{constructor(t,e,n){this.clock=t,this.len=e,this.exists=n}}const Ct=(t,e,n)=>new St(t,e,n);class vt{constructor(t){this.sorted=!1,this._lastIsUsed=!1,this._ids=t}copy(){return new vt(this._ids.slice())}add(t,e){const n=this._ids[this._ids.length-1];n.clock+n.len===t?this._lastIsUsed?(this._ids[this._ids.length-1]=new _t(n.clock,n.len+e),this._lastIsUsed=!1):this._ids[this._ids.length-1].len+=e:(this.sorted=!1,this._ids.push(new _t(t,e)))}getIds(){const t=this._ids;if(this._lastIsUsed=!0,!this.sorted){let e,n;for(this.sorted=!0,t.sort((t,e)=>t.clock-e.clock),e=1,n=1;e<t.length;e++){const s=t[n-1],r=t[e];if(s.clock+s.len>=r.clock){const e=r.clock+r.len-s.clock;s.len<e&&(t[n-1]=new _t(s.clock,e))}else 0===s.len?t[n-1]=r:(n<e&&(t[n]=r),n++)}t.length=0===t[n-1].len?n-1:n}return t}}class Et{constructor(){this.clients=new Map}isEmpty(){return 0===this.clients.size}forEach(t){this.clients.forEach((e,n)=>{e.getIds().forEach(e=>{t(e,n)})})}hasId(t){return this.has(t.client,t.clock)}has(t,e){const n=this.clients.get(t);return!!n&&null!==At(n.getIds(),e)}slice(t,e,n){const s=this.clients.get(t),r=[];if(s){const t=s.getIds();let i=xt(t,e);if(null!==i){let s=null;for(;i<t.length;){let o=t[i];if(o.clock<e&&(o=new _t(e,o.len-(e-o.clock))),o.clock+o.len>e+n&&(o=new _t(o.clock,e+n-o.clock)),o.len<=0)break;const l=null!=s?s.clock+s.len:e;l<o.clock&&r.push(Ct(l,o.clock-l,!1)),s=o,r.push(Ct(o.clock,o.len,!0)),i++}}}if(r.length>0){const t=r[r.length-1],s=t.clock+t.len;s<e+n&&r.push(Ct(s,e+n-s,!1))}else r.push(Ct(e,n,!1));return r}add(t,e,n){Rt(this,t,e,n)}delete(t,e,n){Dt(this,t,e,n)}[yt](t){return Ht(this,t)}}const Dt=(t,e,n,s)=>{const r=t.clients.get(e);if(r&&s>0){const i=r.getIds();let o=xt(i,n);if(null!=o)for(let r=i[o];o<i.length&&r.clock<n+s;r=i[++o])if(r.clock<n)i[o]=r.copyWith(r.clock,n-r.clock),n+s<r.clock+r.len&&i.splice(o+1,0,r.copyWith(n+s,r.clock+r.len-n-s));else if(n+s<r.clock+r.len)i[o]=r.copyWith(n+s,r.clock+r.len-n-s);else{if(1===i.length)return void t.clients.delete(e);i.splice(o--,1)}}},It=(t,e,n)=>e.clients.forEach((e,s)=>{const r=e.getIds(),i=t.doc.store.clients.get(s);if(null!=i)for(let e=0;e<r.length;e++){const s=r[e];vn(t,i,s.clock,s.len,n)}}),At=(t,e)=>{let n=0,s=t.length-1;for(;n<=s;){const r=g((n+s)/2),i=t[r],o=i.clock;if(o<=e){if(e<o+i.len)return r;n=r+1}else s=r-1}return null},xt=(t,e)=>{let n=0,s=t.length-1;for(;n<=s;){const r=g((n+s)/2),i=t[r],o=i.clock;if(o<=e){if(e<o+i.len)return r;n=r+1}else s=r-1}return n<t.length?n:null},Lt=t=>{const e=new Et;for(let n=0;n<t.length;n++)t[n].clients.forEach((s,r)=>{if(!e.clients.has(r)){const i=s.getIds().slice();for(let e=n+1;e<t.length;e++){const n=t[e].clients.get(r);n&&o(i,n.getIds())}e.clients.set(r,new vt(i))}});return e},Ot=(t,e)=>{e.clients.forEach((e,n)=>{const s=t.clients.get(n);if(s)o(s.getIds(),e.getIds()),s.sorted=!1;else{const s=e.copy();s.sorted=!0,t.clients.set(n,s)}})},Ut=Ot,Mt=(t,e)=>{const n=t instanceof Et?new Et:new di,s=t instanceof Et?vt:ai;return t.clients.forEach((t,r)=>{let i=[];const o=e.clients.get(r),l=t.getIds();if(null==o)i=l.slice();else{const t=o.getIds();let e=0,n=0,s=l[0];for(;e<l.length&&n<t.length;){const r=t[n];if(s.clock+s.len<=r.clock)s.len>0&&i.push(s),s=l[++e];else if(r.clock+r.len<=s.clock)n++;else if(r.clock<=s.clock){const t=r.clock+r.len,i=s.clock+s.len-t;i>0?(s=s.copyWith(t,i),n++):s=l[++e]}else{const t=r.clock-s.clock;i.push(s.copyWith(s.clock,t)),s=s.copyWith(s.clock+r.len+t,k(s.len-r.len-t,0)),0===s.len?s=l[++e]:n++}}for(null!=s&&i.push(s),e++;e<l.length;)i.push(l[e++])}i.length>0&&n.clients.set(r,new s(i))}),n},Tt=Mt,Nt=(t,e)=>{const n=t instanceof Et?new Et:new di,s=t instanceof Et?vt:ai;return t.clients.forEach((t,r)=>{const i=[],o=e.clients.get(r),l=t.getIds();if(null!=o){const t=o.getIds();for(let e=0,n=0;e<l.length&&n<t.length;){const s=l[e],r=t[n],o=k(s.clock,r.clock),c=p(s.len-(o-s.clock),r.len-(o-r.clock));c>0&&i.push(s instanceof ci?new ci(o,c,s.attrs.concat(r.attrs)):new _t(o,c)),s.clock+s.len<r.clock+r.len?e++:n++}}i.length>0&&n.clients.set(r,new s(i))}),n},Rt=(t,e,n,s)=>{if(0===s)return;const r=t.clients.get(e);r?r.add(n,s):t.clients.set(e,new vt([new _t(n,s)]))},Vt=(t,e)=>Rt(t,e.id.client,e.id.clock,e.length),Ft=()=>new Et,Pt=t=>{const e=Ft();return t.clients.forEach((t,n)=>{const s=[];for(let e=0;e<t.length;e++){const n=t[e];if(n.deleted){const r=n.id.clock;let i=n.length;if(e+1<t.length)for(let n=t[e+1];e+1<t.length&&n.deleted;n=t[1+ ++e])i+=n.length;s.push(new _t(r,i))}}s.length>0&&e.clients.set(n,new vt(s))}),e},jt=(t,e)=>{const n=Ft();return t.clients.forEach((t,s)=>{const r=((t,e)=>{const n=[];for(let s=0;s<t.length;s++){const r=t[s];if(!e||!r.deleted){const i=r.id.clock;let o=r.length;if(s+1<t.length)for(let n=t[s+1];s+1<t.length&&(!e||!n.deleted);n=t[1+ ++s])o+=n.length;n.push(new _t(i,o))}}return n})(t,e);0!==r.length&&n.clients.set(s,new vt(r))}),n},Jt=(t,e)=>{V(t.restEncoder,e.clients.size),l(e.clients.entries()).sort((t,e)=>e[0]-t[0]).forEach(([e,n])=>{const s=n.getIds();t.resetIdSetCurVal(),V(t.restEncoder,e);const r=s.length;V(t.restEncoder,r);for(let e=0;e<r;e++){const n=s[e];t.writeIdSetClock(n.clock),t.writeIdSetLen(n.len)}})},zt=t=>{const e=new Et,n=ht(t.restDecoder);for(let s=0;s<n;s++){t.resetDsCurVal();const n=ht(t.restDecoder),s=ht(t.restDecoder);if(s>0){const r=[];for(let e=0;e<s;e++)r.push(new _t(t.readDsClock(),t.readDsLen()));e.clients.set(n,new vt(r))}}return e},Bt=(t,e,n)=>{const s=new Et,r=ht(t.restDecoder);for(let i=0;i<r;i++){t.resetDsCurVal();const r=ht(t.restDecoder),i=ht(t.restDecoder),o=n.clients.get(r)||[],l=wn(n,r);for(let n=0;n<i;n++){const n=t.readDsClock(),i=n+t.readDsLen();if(n<l){l<i&&Rt(s,r,l,i-l);let t=yn(o,n),c=o[t];for(!c.deleted&&c.id.clock<n&&c instanceof $o&&o.splice(++t,0,Jo(e,c,n-c.id.clock));t<o.length&&(c=o[t++],c.id.clock<i);)if(!c.deleted)if(c instanceof $o)i<c.id.clock+c.length&&o.splice(t,0,Jo(e,c,i-c.id.clock)),c.delete(e);else{const t=k(c.id.clock,n);s.add(r,t,p(c.length,i-t))}}else Rt(s,r,n,i-n)}}if(s.clients.size>0){const t=new Te;return V(t.restEncoder,0),Jt(t,s),t.toUint8Array()}return null},Ht=(t,e)=>{if(t.clients.size!==e.clients.size)return!1;for(const[n,s]of t.clients.entries()){const t=s.getIds(),r=e.clients.get(n)?.getIds();if(void 0===r||t.length!==r.length)return!1;for(let e=0;e<t.length;e++){const n=t[e],s=r[e];if(n.clock!==s.clock||n.len!==s.len)return!1}}return!0},$t=crypto.getRandomValues.bind(crypto),Wt=()=>$t(new Uint32Array(1))[0],Kt=[1e7]+-1e3+-4e3+-8e3+-1e11,Yt=()=>Kt.replace(/[018]/g,t=>(t^Wt()&15>>t/4).toString(16)),Gt=Date.now,Xt=t=>new Promise(t);Promise.all.bind(Promise);const qt=Wt;class Zt extends d{constructor({guid:t=Yt(),collectionid:e=null,gc:n=!0,gcFilter:s=()=>!0,meta:r=null,autoLoad:i=!1,shouldLoad:o=!0,isSuggestionDoc:l=!1}={}){super(),this.gc=n,this.gcFilter=s,this.clientID=qt(),this.guid=t,this.collectionid=e,this.isSuggestionDoc=l,this.cleanupFormatting=!l,this.share=new Map,this.store=new pn,this._transaction=null,this._transactionCleanups=[],this.subdocs=new Set,this._item=null,this.shouldLoad=o,this.autoLoad=i,this.meta=r,this.isLoaded=!1,this.isSynced=!1,this.isDestroyed=!1,this.whenLoaded=Xt(t=>{this.on("load",()=>{this.isLoaded=!0,t(this)})});const c=()=>Xt(t=>{const e=n=>{void 0!==n&&!0!==n||(this.off("sync",e),t())};this.on("sync",e)});this.on("sync",t=>{!1===t&&this.isSynced&&(this.whenSynced=c()),this.isSynced=void 0===t||!0===t,this.isSynced&&!this.isLoaded&&this.emit("load",[this])}),this.whenSynced=c()}load(){const t=this._item;null===t||this.shouldLoad||Gs(t.parent.doc,t=>{t.subdocsLoaded.add(this)},null,!0),this.shouldLoad=!0}getSubdocs(){return this.subdocs}getSubdocGuids(){return new Set(l(this.subdocs).map(t=>t.guid))}transact(t,e=null){return Gs(this,t,e)}get(t,e=Ui){const n=s(this.share,t,()=>{const t=new e;return t._integrate(this,null),t}),r=n.constructor;if(e!==Ui&&r!==e){if(r===Ui){const s=new e;s._map=n._map,n._map.forEach(t=>{for(;null!==t;t=t.left)t.parent=s}),s._start=n._start;for(let t=s._start;null!==t;t=t.right)t.parent=s;return s._length=n._length,this.share.set(t,s),s._integrate(this,null),s}throw new Error(`Type with the name ${t} has already been defined with a different constructor`)}return n}getArray(t=""){return this.get(t,Zi)}getText(t=""){return this.get(t,go)}getMap(t=""){return this.get(t,Qi)}getXmlElement(t=""){return this.get(t,po)}getXmlFragment(t=""){return this.get(t,fo)}toJSON(){const t={};return this.share.forEach((e,n)=>{t[n]=e.toJSON()}),t}destroy(){this.isDestroyed=!0,l(this.subdocs).forEach(t=>t.destroy());const t=this._item;if(null!==t){this._item=null;const e=t.content;e.doc=new Zt({guid:this.guid,...e.opts,shouldLoad:!1}),e.doc._item=t,Gs(t.parent.doc,n=>{const s=e.doc;t.deleted||n.subdocsAdded.add(s),n.subdocsRemoved.add(this)},null,!0)}this.emit("destroyed",[!0]),this.emit("destroy",[this]),super.destroy()}}const Qt=t=>void 0===t?null:t;let te=new class{constructor(){this.map=new Map}setItem(t,e){this.map.set(t,e)}getItem(t){return this.map.get(t)}},ee=!0;try{"undefined"!=typeof localStorage&&localStorage&&(te=localStorage,ee=!1)}catch(t){}const ne=te,se=Object.assign,re=Object.keys,ie=t=>re(t).length,oe=t=>re(t).length,le=t=>{for(const e in t)return!1;return!0},ce=(t,e)=>{for(const n in t)if(!e(t[n],n))return!1;return!0},he=(t,e)=>Object.prototype.hasOwnProperty.call(t,e),ae=Object.freeze,ue=t=>{for(const e in t){const n=t[e];"object"!=typeof n&&"function"!=typeof n||ue(t[e])}return ae(t)},de=(t,e,n=0)=>{try{for(;n<t.length;n++)t[n](...e)}finally{n<t.length&&de(t,e,n+1)}},ge=t=>t,fe=(t,e)=>{if(t===e)return!0;if(null==t||null==e||t.constructor!==e.constructor)return!1;if(null!=t[yt])return t[yt](e);switch(t.constructor){case ArrayBuffer:t=new Uint8Array(t),e=new Uint8Array(e);case Uint8Array:if(t.byteLength!==e.byteLength)return!1;for(let n=0;n<t.length;n++)if(t[n]!==e[n])return!1;break;case Set:if(t.size!==e.size)return!1;for(const n of t)if(!e.has(n))return!1;break;case Map:if(t.size!==e.size)return!1;for(const n of t.keys())if(!e.has(n)||!fe(t.get(n),e.get(n)))return!1;break;case Object:if(ie(t)!==ie(e))return!1;for(const n in t)if(!he(t,n)||!fe(t[n],e[n]))return!1;break;case Array:if(t.length!==e.length)return!1;for(let n=0;n<t.length;n++)if(!fe(t[n],e[n]))return!1;break;default:return!1}return!0},pe="undefined"!=typeof process&&process.release&&/node|io\.js/.test(process.release.name)&&"[object process]"===Object.prototype.toString.call("undefined"!=typeof process?process:0),ke="undefined"!=typeof window&&"undefined"!=typeof document&&!pe;let we;const me=t=>(()=>{if(void 0===we)if(pe){we=e();const t=process.argv;let n=null;for(let e=0;e<t.length;e++){const s=t[e];"-"===s[0]?(null!==n&&we.set(n,""),n=s):null!==n&&(we.set(n,s),n=null)}null!==n&&we.set(n,"")}else"object"==typeof location?(we=e(),(location.search||"?").slice(1).split("&").forEach(t=>{if(0!==t.length){const[e,n]=t.split("=");we.set(`--${D(e,"-")}`,n),we.set(`-${D(e,"-")}`,n)}})):we=e();return we})().has(t),ye=t=>Qt(pe?process.env[t.toUpperCase().replaceAll("-","_")]:ne.getItem(t)),be=t=>me("--"+t)||null!==ye(t),_e=be("production");var Se;const Ce=pe&&(Se=process.env.FORCE_COLOR,["true","1","2"].includes(Se))||!me("--no-colors")&&!be("no-color")&&(!pe||process.stdout.isTTY)&&(!pe||me("--color")||null!==ye("COLORTERM")||(ye("TERM")||"").includes("color")),ve=ke?t=>{let e="";for(let n=0;n<t.byteLength;n++)e+=C(t[n]);return btoa(e)}:t=>Buffer.from(t.buffer,t.byteOffset,t.byteLength).toString("base64"),Ee=t=>{const e=(n=t.byteLength,new Uint8Array(n));var n;return e.set(t),e},De=(t,e)=>{if(0===e)return t;(t=new Uint8Array(t))[0]<<=e;for(let n=1;n<t.length;n++)t[n-1]|=t[n]>>>8-e,t[n]<<=e;return t};class Ie{constructor(t){this.restDecoder=t}resetDsCurVal(){}readDsClock(){return ht(this.restDecoder)}readDsLen(){return ht(this.restDecoder)}}class Ae extends Ie{readLeftID(){return tn(ht(this.restDecoder),ht(this.restDecoder))}readRightID(){return tn(ht(this.restDecoder),ht(this.restDecoder))}readClient(){return ht(this.restDecoder)}readInfo(){return ct(this.restDecoder)}readString(){return ut(this.restDecoder)}readParentInfo(){return 1===ht(this.restDecoder)}readTypeRef(){return ht(this.restDecoder)}readLen(){return ht(this.restDecoder)}readAny(){return ft(this.restDecoder)}readBuf(){return Ee(lt(this.restDecoder))}readJSON(){return JSON.parse(ut(this.restDecoder))}readKey(){return ut(this.restDecoder)}}class xe{constructor(t){this.dsCurrVal=0,this.restDecoder=t}resetDsCurVal(){this.dsCurrVal=0}readDsClock(){return this.dsCurrVal+=ht(this.restDecoder),this.dsCurrVal}readDsLen(){const t=ht(this.restDecoder)+1;return this.dsCurrVal+=t,t}}class Le extends xe{constructor(t){super(t),this.keys=[],ht(t),this.keyClockDecoder=new wt(lt(t)),this.clientDecoder=new kt(lt(t)),this.leftClockDecoder=new wt(lt(t)),this.rightClockDecoder=new wt(lt(t)),this.infoDecoder=new pt(lt(t),ct),this.stringDecoder=new mt(lt(t)),this.parentInfoDecoder=new pt(lt(t),ct),this.typeRefDecoder=new kt(lt(t)),this.lenDecoder=new kt(lt(t))}readLeftID(){return new Ze(this.clientDecoder.read(),this.leftClockDecoder.read())}readRightID(){return new Ze(this.clientDecoder.read(),this.rightClockDecoder.read())}readClient(){return this.clientDecoder.read()}readInfo(){return this.infoDecoder.read()}readString(){return this.stringDecoder.read()}readParentInfo(){return 1===this.parentInfoDecoder.read()}readTypeRef(){return this.typeRefDecoder.read()}readLen(){return this.lenDecoder.read()}readAny(){return ft(this.restDecoder)}readBuf(){return lt(this.restDecoder)}readJSON(){return ft(this.restDecoder)}readKey(){const t=this.keyClockDecoder.read();if(t<this.keys.length)return this.keys[t];{const t=this.stringDecoder.read();return this.keys.push(t),t}}}class Oe{constructor(){this.restEncoder=U()}toUint8Array(){return T(this.restEncoder)}resetIdSetCurVal(){}writeIdSetClock(t){V(this.restEncoder,t)}writeIdSetLen(t){V(this.restEncoder,t)}}class Ue extends Oe{writeLeftID(t){V(this.restEncoder,t.client),V(this.restEncoder,t.clock)}writeRightID(t){V(this.restEncoder,t.client),V(this.restEncoder,t.clock)}writeClient(t){V(this.restEncoder,t)}writeInfo(t){R(this.restEncoder,t)}writeString(t){J(this.restEncoder,t)}writeParentInfo(t){V(this.restEncoder,t?1:0)}writeTypeRef(t){V(this.restEncoder,t)}writeLen(t){V(this.restEncoder,t)}writeAny(t){W(this.restEncoder,t)}writeBuf(t){B(this.restEncoder,t)}writeJSON(t){J(this.restEncoder,JSON.stringify(t))}writeKey(t){J(this.restEncoder,t)}}class Me{constructor(){this.restEncoder=U(),this.dsCurrVal=0}toUint8Array(){return T(this.restEncoder)}resetIdSetCurVal(){this.dsCurrVal=0}writeIdSetClock(t){const e=t-this.dsCurrVal;this.dsCurrVal=t,V(this.restEncoder,e)}writeIdSetLen(t){0===t&&et(),V(this.restEncoder,t-1),this.dsCurrVal+=t}}class Te extends Me{constructor(){super(),this.keyMap=new Map,this.keyClock=0,this.keyClockEncoder=new q,this.clientEncoder=new G,this.leftClockEncoder=new q,this.rightClockEncoder=new q,this.infoEncoder=new K(R),this.stringEncoder=new Z,this.parentInfoEncoder=new K(R),this.typeRefEncoder=new G,this.lenEncoder=new G}toUint8Array(){const t=U();return V(t,0),B(t,this.keyClockEncoder.toUint8Array()),B(t,this.clientEncoder.toUint8Array()),B(t,this.leftClockEncoder.toUint8Array()),B(t,this.rightClockEncoder.toUint8Array()),B(t,T(this.infoEncoder)),B(t,this.stringEncoder.toUint8Array()),B(t,T(this.parentInfoEncoder)),B(t,this.typeRefEncoder.toUint8Array()),B(t,this.lenEncoder.toUint8Array()),z(t,T(this.restEncoder)),T(t)}writeLeftID(t){this.clientEncoder.write(t.client),this.leftClockEncoder.write(t.clock)}writeRightID(t){this.clientEncoder.write(t.client),this.rightClockEncoder.write(t.clock)}writeClient(t){this.clientEncoder.write(t)}writeInfo(t){this.infoEncoder.write(t)}writeString(t){this.stringEncoder.write(t)}writeParentInfo(t){this.parentInfoEncoder.write(t?1:0)}writeTypeRef(t){this.typeRefEncoder.write(t)}writeLen(t){this.lenEncoder.write(t)}writeAny(t){W(this.restEncoder,t)}writeBuf(t){B(this.restEncoder,t)}writeJSON(t){W(this.restEncoder,t)}writeKey(t){const e=this.keyMap.get(t);void 0===e?(this.keyClockEncoder.write(this.keyClock++),this.stringEncoder.write(t)):this.keyClockEncoder.write(e)}}const Ne=(t,e,n,s)=>{let r=0;const o=[],l=e[0].id.clock,c=i(e),h=c.id.clock+c.length;s.forEach(t=>{const n=k(t.clock,l),s=p(t.clock+t.len,h);if(n>=s)return;const i=yn(e,n),c=yn(e,s-1)+1;r+=c-i,o.push({start:i,end:c,startClock:n,endClock:s})}),r+=s.length-1;let a=o[0].startClock;V(t.restEncoder,r),t.writeClient(n),V(t.restEncoder,a),o.forEach(s=>{const r=s.startClock-a;r>0&&(new Yo(tn(n,a),r).write(t,0),a+=r);for(let n=s.start;n<s.end;n++){const r=e[n],i=r.id.clock+r.length,o=k(i-s.endClock,0);r.write(t,a-r.id.clock,o),a=i-o}})},Re=(t,e,n)=>{const s=new Map;n.forEach((t,n)=>{wn(e,n)>t&&s.set(n,t)}),kn(e).forEach((t,e)=>{n.has(e)||s.set(e,0)}),V(t.restEncoder,s.size),l(s.entries()).sort((t,e)=>e[0]-t[0]).forEach(([n,s])=>{const r=e.clients.get(n),i=r[r.length-1];Ne(t,r,n,[new _t(s,i.id.clock+i.length-s)])})},Ve=(t,e,n)=>{V(t.restEncoder,n.clients.size),l(n.clients.entries()).sort((t,e)=>e[0]-t[0]).forEach(([n,s])=>{const r=s.getIds(),i=e.clients.get(n);Ne(t,i,n,r)})},Fe=(t,e,n,r=new Le(t))=>Gs(e,t=>{t.local=!1;let e=!1;const n=t.doc,i=n.store,o=ti(r,n),c=Ft();o.clients.forEach((t,e)=>{const n=i.clients.get(e);if(n){const t=n[n.length-1];c.add(e,0,t.id.clock+t.length),i.skips.clients.get(e)?.getIds().forEach(t=>{c.delete(e,t.clock,t.len)})}}),ei(o,c);const h=((t,e,n)=>{const r=[];let i=l(n.clients.keys()).sort((t,e)=>t-e);if(0===i.length)return null;const o=()=>{if(0===i.length)return null;let t=n.clients.get(i[i.length-1]);for(;t.refs.length===t.i;){if(i.pop(),!(i.length>0))return null;t=n.clients.get(i[i.length-1])}return t};let c=o();if(null===c)return null;const h=new pn,a=new Map,u=(t,e)=>{const n=a.get(t);(null==n||n>e)&&a.set(t,e)};let d=c.refs[c.i++];const g=new Map,f=()=>{for(const t of r){const e=t.id.client,s=n.clients.get(e);s?(s.i--,h.clients.set(e,s.refs.slice(s.i)),n.clients.delete(e),s.i=0,s.refs=[]):h.clients.set(e,[t]),i=i.filter(t=>t!==e)}r.length=0};for(;;){if(d.constructor!==Yo){const i=s(g,d.id.client,()=>wn(e,d.id.client)),o=i-d.id.clock,l=d.getMissing(t,e);if(null!==l){r.push(d);const t=n.clients.get(l)||{refs:[],i:0};if(t.refs.length!==t.i&&l!==d.id.client&&!r.some(t=>t.id.client===l)){d=t.refs[t.i++];continue}u(l,wn(e,l)),f()}else o<0&&new Yo(tn(d.id.client,i),-o).integrate(t,0),d.integrate(t,0),g.set(d.id.client,k(d.id.clock+d.length,i))}if(r.length>0)d=r.pop();else if(null!==c&&c.i<c.refs.length)d=c.refs[c.i++];else{if(c=o(),null===c)break;d=c.refs[c.i++]}}if(h.clients.size>0){const t=new Te;return Re(t,h,new Map),V(t.restEncoder,0),{missing:a,update:t.toUint8Array()}}return null})(t,i,o),a=i.pendingStructs;if(a){for(const[t,n]of a.missing)if(o.clients.has(t)||n<wn(i,t)){e=!0;break}if(h){for(const[t,e]of h.missing){const n=a.missing.get(t);(null==n||n>e)&&a.missing.set(t,e)}a.update=cr([a.update,h.update])}}else i.pendingStructs=h;const u=Bt(r,t,i);if(i.pendingDs){const e=new Le(it(i.pendingDs));ht(e.restDecoder);const n=Bt(e,t,i);i.pendingDs=u&&n?cr([u,n]):u||n}else i.pendingDs=u;if(e){const e=i.pendingStructs.update;i.pendingStructs=null,Pe(t.doc,e)}},n,!1),Pe=(t,e,n,s=Le)=>{const r=it(e);Fe(r,t,n,new s(r))},je=(t,e,n)=>Pe(t,e,n,Ae),Je=(t,e=new Uint8Array([0]),n=new Te)=>{((t,e,n=new Map)=>{Re(t,e.store,n),Jt(t,e.store.ds)})(n,t,He(e));const s=[n.toUint8Array()];if(t.store.pendingDs&&s.push(t.store.pendingDs),t.store.pendingStructs&&s.push(hr(t.store.pendingStructs.update,e)),s.length>1){if(n.constructor===Ue)return rr(s.map((t,e)=>0===e?t:pr(t)));if(n.constructor===Te)return cr(s)}return s[0]},ze=(t,e)=>Je(t,e,new Ue),Be=t=>{const e=new Map,n=ht(t.restDecoder);for(let s=0;s<n;s++){const n=ht(t.restDecoder),s=ht(t.restDecoder);e.set(n,s)}return e},He=t=>Be(new Ie(it(t))),$e=(t,e)=>(V(t.restEncoder,e.size),l(e.entries()).sort((t,e)=>e[0]-t[0]).forEach(([e,n])=>{V(t.restEncoder,e),V(t.restEncoder,n)}),t),We=(t,e=new Me)=>(t instanceof Map?$e(e,t):((t,e)=>{$e(t,kn(e.store))})(e,t),e.toUint8Array());class Ke{constructor(){this.l=[]}}const Ye=()=>new Ke,Ge=(t,e)=>t.l.push(e),Xe=(t,e)=>{const n=t.l,s=n.length;t.l=n.filter(t=>e!==t),s===t.l.length&&console.error("[yjs] Tried to remove event handler that doesn't exist.")},qe=(t,e,n)=>de(t.l,[e,n]);class Ze{constructor(t,e){this.client=t,this.clock=e}}const Qe=(t,e)=>t===e||null!==t&&null!==e&&t.client===e.client&&t.clock===e.clock,tn=(t,e)=>new Ze(t,e),en=(t,e)=>{V(t,e.client),V(t,e.clock)},nn=t=>tn(ht(t),ht(t)),sn=t=>{for(const[e,n]of t.doc.share.entries())if(n===t)return e;throw et()},rn=(t,e)=>{for(;null!==e;){if(e.parent===t)return!0;e=e.parent._item}return!1};class on{constructor(t,e,n,s=0){this.type=t,this.tname=e,this.item=n,this.assoc=s}}class ln{constructor(t,e,n=0){this.type=t,this.index=e,this.assoc=n}}const cn=(t,e,n)=>{let s=null,r=null;return null===t._item?r=sn(t):s=tn(t._item.id.client,t._item.id.clock),new on(s,r,e,n)};class hn{constructor(t,e){this.ds=t,this.sv=e}}const an=(t,e=new Me)=>(Jt(e,t.ds),$e(e,t.sv),e.toUint8Array()),un=(t,e=new xe(it(t)))=>new hn(zt(e),Be(e)),dn=(t,e)=>new hn(t,e),gn=dn(Ft(),new Map),fn=(t,e)=>void 0===e?!t.deleted:e.sv.has(t.id.client)&&(e.sv.get(t.id.client)||0)>t.id.clock&&!e.ds.hasId(t.id);class pn{constructor(){this.clients=new Map,this.pendingStructs=null,this.pendingDs=null,this.skips=Ft()}get ds(){return Pt(this)}}const kn=t=>{const e=new Map;return t.clients.forEach((t,n)=>{const s=t[t.length-1];e.set(n,s.id.clock+s.length)}),t.skips.clients.forEach((t,n)=>{e.set(n,t.getIds()[0].clock)}),e},wn=(t,e)=>{const n=t.clients.get(e);if(void 0===n)return 0;const s=n[n.length-1];return s.id.clock+s.length},mn=(t,e)=>{let n=t.clients.get(e.id.client);if(void 0===n)n=[],t.clients.set(e.id.client,n);else{const s=n[n.length-1];if(s.id.clock+s.length!==e.id.clock){let s=yn(n,e.id.clock);const r=n[s],i=e.id.clock-r.id.clock,o=r.id.clock+r.length-e.id.clock-e.length;return i>0&&n.splice(s++,0,new Yo(tn(e.id.client,r.id.clock),i)),o>0&&n.splice(s+1,0,new Yo(tn(e.id.client,e.id.clock+e.length),o)),n[s]=e,void t.skips.delete(e.id.client,e.id.clock,e.length)}}n.push(e)},yn=(t,e)=>{let n=0,s=t.length-1,r=t[s],i=r.id.clock;if(i===e)return s;let o=g(e/(i+r.length-1)*s);for(;n<=s;){if(r=t[o],i=r.id.clock,i<=e){if(e<i+r.length)return o;n=o+1}else s=o-1;o=g((n+s)/2)}throw et()},bn=(t,e)=>{const n=t.clients.get(e.client);return n[yn(n,e.clock)]},_n=(t,e,n)=>{const s=yn(e,n),r=e[s];return r.id.clock<n?(e.splice(s+1,0,zo(t,r,n-r.id.clock)),s+1):s},Sn=(t,e)=>{const n=t.doc.store.clients.get(e.client);return n[_n(t,n,e.clock)]},Cn=(t,e,n)=>{const s=e.clients.get(n.client),r=yn(s,n.clock),i=s[r];return n.clock!==i.id.clock+i.length-1&&i.constructor!==yo&&s.splice(r+1,0,Jo(t,i,n.clock-i.id.clock+1)),i},vn=(t,e,n,s,r)=>{if(0===s)return;const i=n+s;let o,l=_n(t,e,n);do{o=e[l++],i<o.id.clock+o.length&&_n(t,e,i),r(o)}while(l<e.length&&e[l].id.clock<i)};class En{constructor(t,e){this.left=t,this.right=e}}const Dn=(t,e)=>new En(t,e),In=Symbol("0schema");class An{constructor(){this._rerrs=[]}extend(t,e,n,s=null){this._rerrs.push({path:t,expected:e,has:n,message:s})}toString(){const t=[];for(let e=this._rerrs.length-1;e>0;e--){const n=this._rerrs[e];t.push(L(" ",2*(this._rerrs.length-e))+`${null!=n.path?`[${n.path}] `:""}${n.has} doesn't match ${n.expected}. ${n.message}`)}return t.join("\n")}}const xn=(t,e)=>t===e||null!=t&&null!=e&&t.constructor===e.constructor&&(t[yt]?bt(t,e):a(t)?c(t,t=>h(e,e=>xn(t,e))):"object"==typeof t&&ce(t,(t,n)=>xn(t,e[n])));class Ln{static _dilutes=!1;extends(t){let[e,n]=[this.shape,t.shape];return this.constructor._dilutes&&([n,e]=[e,n]),xn(e,n)}equals(t){return this.constructor===t.constructor&&fe(this.shape,t.shape)}[In](){return!0}[yt](t){return this.equals(t)}validate(t){return this.check(t)}check(t,e){tt()}get nullable(){return is(this,ws)}get optional(){return new Jn(this)}cast(t){return bs(t,this),t}expect(t){return bs(t,this),t}}class On extends Ln{constructor(t,e){super(),this.shape=t,this._c=e}check(t,e=void 0){const n=t?.constructor===this.shape&&(null==this._c||this._c(t));return!n&&e?.extend(null,this.shape.name,t?.constructor.name,t?.constructor!==this.shape?"Constructor match failed":"Check failed"),n}}const Un=(t,e=null)=>new On(t,e);Un(On);class Mn extends Ln{constructor(t){super(),this.shape=t}check(t,e){const n=this.shape(t);return!n&&e?.extend(null,"custom prop",t?.constructor.name,"failed to check custom prop"),n}}const Tn=t=>new Mn(t);Un(Mn);class Nn extends Ln{constructor(t){super(),this.shape=t}check(t,e){const n=this.shape.some(e=>e===t);return!n&&e?.extend(null,this.shape.join(" | "),t.toString()),n}}const Rn=(...t)=>new Nn(t),Vn=Un(Nn),Fn=RegExp.escape||(t=>t.replace(/[().|&,$^[\]]/g,t=>"\\"+t)),Pn=t=>gs.check(t)?[Fn(t)]:Vn.check(t)?t.shape.map(t=>t+""):ds.check(t)?["[+-]?\\d+.?\\d*"]:fs.check(t)?[".*"]:os.check(t)?t.shape.map(Pn).flat(1):void et();Un(class extends Ln{constructor(t){super(),this.shape=t,this._r=new RegExp("^"+t.map(Pn).map(t=>`(${t.join("|")})`).join("")+"$")}check(t,e){const n=null!=this._r.exec(t);return!n&&e?.extend(null,this._r.toString(),t.toString(),"String doesn't match string template."),n}});const jn=Symbol("optional");class Jn extends Ln{constructor(t){super(),this.shape=t}check(t,e){const n=void 0===t||this.shape.check(t);return!n&&e?.extend(null,"undefined (optional)","()"),n}get[jn](){return!0}}Un(Jn);class zn extends Ln{check(t,e){return e?.extend(null,"never",typeof t),!1}}const Bn=new zn;Un(zn);class Hn extends Ln{constructor(t,e=!1){super(),this.shape=t,this._isPartial=e}static _dilutes=!0;get partial(){return new Hn(this.shape,!0)}check(t,e){return null==t?(e?.extend(null,"object","null"),!1):ce(this.shape,(n,s)=>{const r=this._isPartial&&!he(t,s)||n.check(t[s],e);return!r&&e?.extend(s.toString(),n.toString(),typeof t[s],"Object property does not match"),r})}}const $n=t=>new Hn(t);Un(Hn);const Wn=Tn(t=>null!=t&&(t.constructor===Object||null==t.constructor));class Kn extends Ln{constructor(t,e){super(),this.shape={keys:t,values:e}}check(t,e){return null!=t&&ce(t,(n,s)=>{const r=this.shape.keys.check(s,e);return!r&&e?.extend(s+"","Record",typeof t,r?"Key doesn't match schema":"Value doesn't match value"),r&&this.shape.values.check(n,e)})}}const Yn=(t,e)=>new Kn(t,e),Gn=Un(Kn);class Xn extends Ln{constructor(t){super(),this.shape=t}check(t,e){return null!=t&&ce(this.shape,(n,s)=>{const r=n.check(t[s],e);return!r&&e?.extend(s.toString(),"Tuple",typeof n),r})}}Un(Xn);class qn extends Ln{constructor(t){super(),this.shape=1===t.length?t[0]:new rs(t)}check(t,e){const n=a(t)&&c(t,t=>this.shape.check(t));return!n&&e?.extend(null,"Array",""),n}}const Zn=(...t)=>new qn(t);Un(qn);const Qn=Tn(t=>a(t));class ts extends Ln{constructor(t,e){super(),this.shape=t,this._c=e}check(t,e){const n=t instanceof this.shape&&(null==this._c||this._c(t));return!n&&e?.extend(null,this.shape.name,t?.constructor.name),n}}const es=(t,e=null)=>new ts(t,e);Un(ts);const ns=es(Ln);Un(class extends Ln{constructor(t){super(),this.len=t.length-1,this.args=((...t)=>new Xn(t))(...t.slice(-1)),this.res=t[this.len]}check(t,e){const n=t.constructor===Function&&t.length<=this.len;return!n&&e?.extend(null,"function",typeof t),n}});const ss=Tn(t=>"function"==typeof t);Un(class extends Ln{constructor(t){super(),this.shape=t}check(t,e){const n=c(this.shape,n=>n.check(t,e));return!n&&e?.extend(null,"Intersectinon",typeof t),n}},t=>t.shape.length>0);class rs extends Ln{static _dilutes=!0;constructor(t){super(),this.shape=t}check(t,e){const n=h(this.shape,n=>n.check(t,e));return e?.extend(null,"Union",typeof t),n}}const is=(...t)=>t.findIndex(t=>os.check(t))>=0?is(...t.map(t=>os.check(t)?t.shape:[t]).flat(1)):1===t.length?t[0]:new rs(t),os=Un(rs),ls=()=>!0,cs=Tn(ls);Un(Mn,t=>t.shape===ls);const hs=Un(BigInt);Un(On,t=>t.shape===BigInt);const as=Un(Symbol);Un(On,t=>t.shape===Symbol);const us=Un(Number),ds=Un(On,t=>t.shape===Number),gs=Un(String),fs=Un(On,t=>t.shape===String),ps=Un(Boolean);Un(On,t=>t.shape===Boolean);const ks=Rn(void 0);Un(Nn,t=>1===t.shape.length&&void 0===t.shape[0]),Rn(void 0);const ws=Rn(null);Un(Nn,t=>1===t.shape.length&&null===t.shape[0]),Un(Uint8Array),Un(On,t=>t.shape===Uint8Array);const ms=is(us,gs,ws,ks,hs,ps,as);(()=>{const t=Zn(cs),e=Yn(gs,cs),n=is(us,gs,ws,ps,t,e);t.shape=n,e.shape.values=n})();const ys=t=>{if(ns.check(t))return t;if(Wn.check(t)){const e={};for(const n in t)e[n]=ys(t[n]);return $n(e)}return Qn.check(t)?is(...t.map(ys)):ms.check(t)?Rn(t):ss.check(t)?Un(t):void et()},bs=_e?()=>{}:(t,e)=>{const n=new An;if(!e.check(t,n))throw Q(`Expected value to be of type ${e.constructor.name}.\n${n.toString()}`)},_s="undefined"!=typeof document?document:{};Tn(t=>t.nodeType===Ds),"undefined"!=typeof DOMParser&&new DOMParser,Tn(t=>t.nodeType===Cs),Tn(t=>t.nodeType===vs);const Ss=t=>((t,e)=>{const n=[];for(const[s,r]of t)n.push(e(r,s));return n})(t,(t,e)=>`${e}:${t};`).join(""),Cs=_s.ELEMENT_NODE,vs=_s.TEXT_NODE,Es=_s.DOCUMENT_NODE,Ds=_s.DOCUMENT_FRAGMENT_NODE;Tn(t=>t.nodeType===Es);const Is=Symbol,As=Is(),xs=Is(),Ls=Is(),Os=Is(),Us=Is(),Ms=Is(),Ts=Is(),Ns=Is(),Rs=Is(),Vs={[As]:Dn("font-weight","bold"),[xs]:Dn("font-weight","normal"),[Ls]:Dn("color","blue"),[Us]:Dn("color","green"),[Os]:Dn("color","grey"),[Ms]:Dn("color","red"),[Ts]:Dn("color","purple"),[Ns]:Dn("color","orange"),[Rs]:Dn("color","black")},Fs=Ce?t=>{1===t.length&&t[0]?.constructor===Function&&(t=t[0]());const n=[],s=[],r=e();let i=[],o=0;for(;o<t.length;o++){const e=t[o],i=Vs[e];if(void 0!==i)r.set(i.left,i.right);else{if(void 0===e)break;if(e.constructor!==String&&e.constructor!==Number)break;{const t=Ss(r);o>0||t.length>0?(n.push("%c"+e),s.push(t)):n.push(e)}}}for(o>0&&(i=s,i.unshift(n.join("")));o<t.length;o++){const e=t[o];e instanceof Symbol||i.push(e)}return i}:t=>{1===t.length&&t[0]?.constructor===Function&&(t=t[0]());const e=[],n=[];let s=0;for(;s<t.length;s++){const n=t[s];if(void 0===n)break;if(n.constructor===String||n.constructor===Number)e.push(n);else if(n.constructor===Object)break}for(s>0&&n.push(e.join(""));s<t.length;s++){const e=t[s];e instanceof Symbol||n.push(e)}return n},Ps=(...t)=>{console.log(...Fs(t)),Js.forEach(e=>e.print(t))},js=(...t)=>{console.warn(...Fs(t)),t.unshift(Ns),Js.forEach(e=>e.print(t))},Js=r();class zs{constructor(t,e,n){this.doc=t,this.deleteSet=Ft(),this.cleanUps=Ft(),this.insertSet=Ft(),this._beforeState=null,this._afterState=null,this.changed=new Map,this.changedParentTypes=new Map,this._mergeStructs=[],this.origin=e,this.meta=new Map,this.local=n,this.subdocsAdded=new Set,this.subdocsRemoved=new Set,this.subdocsLoaded=new Set,this._needFormattingCleanup=!1,this._done=!1}get beforeState(){if(null==this._beforeState){const t=kn(this.doc.store);this.insertSet.clients.forEach((e,n)=>{t.set(n,e.getIds()[0].clock)}),this._beforeState=t}return this._beforeState}get afterState(){if(this._done||et(),null==this._afterState){const t=kn(this.doc.store);this.insertSet.clients.forEach((e,n)=>{const s=e.getIds(),r=s[s.length-1];t.set(n,r.clock+r.len)}),this._afterState=t}return this._afterState}}const Bs=(t,e)=>(0!==e.deleteSet.clients.size||0!==e.insertSet.clients.size)&&(((t,e)=>{Ve(t,e.doc.store,e.insertSet)})(t,e),Jt(t,e.deleteSet),!0),Hs=(t,e,n)=>{const i=e._item;null!==i&&(i.deleted||t.insertSet.hasId(i.id))||s(t.changed,e,r).add(n)},$s=(t,e)=>{let n=t[e],s=t[e-1],r=e;for(;r>0&&(s.deleted===n.deleted&&s.constructor===n.constructor&&s.mergeWith(n));n=s,s=t[--r-1])n instanceof $o&&null!==n.parentSub&&n.parent._map.get(n.parentSub)===n&&n.parent._map.set(n.parentSub,s);const i=e-r;return i&&t.splice(e+1-i,i),i},Ws=(t,e,n)=>{for(const[s,r]of e.clients.entries()){const e=r.getIds(),i=t.doc.store.clients.get(s);for(let s=e.length-1;s>=0;s--){const r=e[s],o=r.clock+r.len;for(let e=yn(i,r.clock),s=i[e];e<i.length&&s.id.clock<o;s=i[++e]){const s=i[e];if(r.clock+r.len<=s.id.clock)break;s instanceof $o&&s.deleted&&!s.keep&&n(s)&&s.gc(t,!1)}}}},Ks=(t,e)=>{t.clients.forEach((t,n)=>{const s=t.getIds(),r=e.clients.get(n);for(let t=s.length-1;t>=0;t--){const e=s[t];for(let t=p(r.length-1,1+yn(r,e.clock+e.len-1)),n=r[t];t>0&&n.id.clock>=e.clock;n=r[t])t-=1+$s(r,t)}})},Ys=(t,e)=>{if(e<t.length){const n=t[e];n._done=!0;const s=n.doc,r=s.store,i=n.deleteSet,o=n._mergeStructs;try{s.emit("beforeObserverCalls",[n,s]);const t=[];n.changed.forEach((e,s)=>t.push(()=>{null!==s._item&&s._item.deleted||s._callObserver(n,e)})),t.push(()=>{n.changedParentTypes.forEach((t,e)=>{e._dEH.l.length>0&&(null===e._item||!e._item.deleted)&&((t=t.filter(t=>null===t.target._item||!t.target._item.deleted)).forEach(t=>{t.currentTarget=e,t._path=null}),t.sort((t,e)=>t.path.length-e.path.length),qe(e._dEH,t,n))})}),t.push(()=>s.emit("afterTransaction",[n,s])),de(t,[]),n._needFormattingCleanup&&s.cleanupFormatting&&ao(n)}finally{s.gc&&Ws(n,i,s.gcFilter),Ks(i,r),n.insertSet.clients.forEach((t,e)=>{const n=t.getIds()[0].clock,s=r.clients.get(e),i=k(yn(s,n),1);for(let t=s.length-1;t>=i;)t-=1+$s(s,t)});for(let t=o.length-1;t>=0;t--){const{client:e,clock:n}=o[t].id,s=r.clients.get(e),i=yn(s,n);i+1<s.length&&$s(s,i+1)>1||i>0&&$s(s,i)}if(!n.local&&n.insertSet.clients.has(s.clientID)&&(Ps(Ns,As,"[yjs] ",xs,Ms,"Changed the client-id because another client seems to be using it."),s.clientID=qt()),s.emit("afterTransactionCleanup",[n,s]),s._observers.has("update")){const t=new Ue;Bs(t,n)&&s.emit("update",[t.toUint8Array(),n.origin,s,n])}if(s._observers.has("updateV2")){const t=new Te;Bs(t,n)&&s.emit("updateV2",[t.toUint8Array(),n.origin,s,n])}const{subdocsAdded:l,subdocsLoaded:c,subdocsRemoved:h}=n;(l.size>0||h.size>0||c.size>0)&&(l.forEach(t=>{t.clientID=s.clientID,null==t.collectionid&&(t.collectionid=s.collectionid),s.subdocs.add(t)}),h.forEach(t=>s.subdocs.delete(t)),s.emit("subdocs",[{loaded:c,added:l,removed:h},s,n]),h.forEach(t=>t.destroy())),t.length<=e+1?(s._transactionCleanups=[],s.emit("afterAllTransactions",[s,t])):Ys(t,e+1)}}},Gs=(t,e,n=null,s=!0)=>{const r=t._transactionCleanups;let i=!1,o=null;null===t._transaction&&(i=!0,t._transaction=new zs(t,n,s),r.push(t._transaction),1===r.length&&t.emit("beforeAllTransactions",[t]),t.emit("beforeTransaction",[t._transaction,t]));try{o=e(t._transaction)}finally{if(i){const e=t._transaction===r[0];t._transaction=null,e&&Ys(r,0)}}return o};class Xs{constructor(t,e){this.insertions=e,this.deletions=t,this.meta=new Map}}const qs=(t,e,n)=>{It(t,n.deletions,n=>{n instanceof $o&&e.scope.some(e=>e===t.doc||rn(e,n))&&jo(n,!1)})},Zs=(t,e,n)=>{let s=null;const r=t.doc,i=t.scope;Gs(r,n=>{for(;e.length>0&&null===t.currStackItem;){const s=r.store,o=e.pop(),l=new Set,c=[];let h=!1;It(n,o.insertions,t=>{if(t instanceof $o){if(null!==t.redone){let{item:e,diff:r}=Po(s,t.id);r>0&&(e=Sn(n,tn(e.id.client,e.id.clock+r))),t=e}!t.deleted&&i.some(e=>e===n.doc||rn(e,t))&&c.push(t)}}),It(n,o.deletions,t=>{t instanceof $o&&i.some(e=>e===n.doc||rn(e,t))&&!o.insertions.hasId(t.id)&&l.add(t)}),l.forEach(e=>{h=null!==Ho(n,e,l,o.insertions,t.ignoreRemoteMapChanges,t)||h});for(let e=c.length-1;e>=0;e--){const s=c[e];t.deleteFilter(s)&&(s.delete(n),h=!0)}t.currStackItem=h?o:null}n.changed.forEach((t,e)=>{t.has(null)&&e._searchMarker&&(e._searchMarker.length=0)}),s=n},t);const o=t.currStackItem;if(null!=o){const e=s.changedParentTypes;t.emit("stack-item-popped",[{stackItem:o,type:n,changedParentTypes:e,origin:t},t]),t.currStackItem=null}return o};class Qs extends d{constructor(t,{captureTimeout:e=500,captureTransaction:n=t=>!0,deleteFilter:s=()=>!0,trackedOrigins:r=new Set([null]),ignoreRemoteMapChanges:i=!1,doc:o=(a(t)?t[0].doc:t instanceof Zt?t:t.doc)}={}){super(),this.scope=[],this.doc=o,this.addToScope(t),this.deleteFilter=s,r.add(this),this.trackedOrigins=r,this.captureTransaction=n,this.undoStack=[],this.redoStack=[],this.undoing=!1,this.redoing=!1,this.currStackItem=null,this.lastChange=0,this.ignoreRemoteMapChanges=i,this.captureTimeout=e,this.afterTransactionHandler=t=>{if(!(this.captureTransaction(t)&&this.scope.some(e=>t.changedParentTypes.has(e)||e===this.doc)&&(this.trackedOrigins.has(t.origin)||t.origin&&this.trackedOrigins.has(t.origin.constructor))))return;const e=this.undoing,n=this.redoing,s=e?this.redoStack:this.undoStack;e?this.stopCapturing():n||this.clear(!1,!0);const r=t.insertSet,i=Gt();let o=!1;if(this.lastChange>0&&i-this.lastChange<this.captureTimeout&&s.length>0&&!e&&!n){const e=s[s.length-1];e.deletions=Lt([e.deletions,t.deleteSet]),e.insertions=Lt([e.insertions,r])}else s.push(new Xs(t.deleteSet,r)),o=!0;e||n||(this.lastChange=i),It(t,t.deleteSet,e=>{e instanceof $o&&this.scope.some(n=>n===t.doc||rn(n,e))&&jo(e,!0)});const l=[{stackItem:s[s.length-1],origin:t.origin,type:e?"redo":"undo",changedParentTypes:t.changedParentTypes},this];o?this.emit("stack-item-added",l):this.emit("stack-item-updated",l)},this.doc.on("afterTransaction",this.afterTransactionHandler),this.doc.on("destroy",()=>{this.destroy()})}addToScope(t){const e=new Set(this.scope);(t=a(t)?t:[t]).forEach(t=>{e.has(t)||(e.add(t),(t instanceof Ui?t.doc!==this.doc:t!==this.doc)&&js("[yjs#509] Not same Y.Doc"),this.scope.push(t))})}addTrackedOrigin(t){this.trackedOrigins.add(t)}removeTrackedOrigin(t){this.trackedOrigins.delete(t)}clear(t=!0,e=!0){(t&&this.canUndo()||e&&this.canRedo())&&this.doc.transact(n=>{t&&(this.undoStack.forEach(t=>qs(n,this,t)),this.undoStack=[]),e&&(this.redoStack.forEach(t=>qs(n,this,t)),this.redoStack=[]),this.emit("stack-cleared",[{undoStackCleared:t,redoStackCleared:e}])})}stopCapturing(){this.lastChange=0}undo(){let t;this.undoing=!0;try{t=Zs(this,this.undoStack,"undo")}finally{this.undoing=!1}return t}redo(){let t;this.redoing=!0;try{t=Zs(this,this.redoStack,"redo")}finally{this.redoing=!1}return t}canUndo(){return this.undoStack.length>0}canRedo(){return this.redoStack.length>0}destroy(){this.trackedOrigins.delete(this),this.doc.off("afterTransaction",this.afterTransactionHandler),super.destroy()}}class tr{constructor(t,e){this.gen=function*(t){const e=ht(t.restDecoder);for(let n=0;n<e;n++){const e=ht(t.restDecoder),n=t.readClient();let s=ht(t.restDecoder);for(let r=0;r<e;r++){const e=t.readInfo();if(10===e){const e=ht(t.restDecoder);yield new Yo(tn(n,s),e),s+=e}else if(31&e){const r=!(192&e),i=new $o(tn(n,s),null,(e&y)===y?t.readLeftID():null,null,(e&m)===m?t.readRightID():null,r?t.readParentInfo()?t.readString():t.readLeftID():null,!r||32&~e?null:t.readString(),Wo(t,e));yield i,s+=i.length}else{const e=t.readLen();yield new yo(tn(n,s),e),s+=e}}}}(t),this.curr=null,this.done=!1,this.filterSkips=e,this.next()}next(){do{this.curr=this.gen.next().value||null}while(this.filterSkips&&null!==this.curr&&this.curr.constructor===Yo);return this.curr}}const er=(t,e=Le)=>{const n=[],s=new e(it(t)),r=new tr(s,!1);for(let t=r.curr;null!==t;t=r.next())n.push(t);Ps("Structs: ",n);const i=zt(s);Ps("DeleteSet: ",i)},nr=(t,e=Le)=>{const n=[],s=new e(it(t)),r=new tr(s,!1);for(let t=r.curr;null!==t;t=r.next())n.push(t);return{structs:n,ds:zt(s)}};class sr{constructor(t){this.currClient=0,this.startClock=0,this.written=0,this.encoder=t,this.clientStructs=[]}}const rr=t=>cr(t,Ae,Ue),ir=(t,e=Me,n=Le)=>{const s=new e,r=new tr(new n(it(t)),!1);let i=r.curr;if(null!==i){let t=0,e=i.id.client,n=0!==i.id.clock,o=n?0:i.id.clock+i.length;for(;null!==i;i=r.next())e!==i.id.client&&(0!==o&&(t++,V(s.restEncoder,e),V(s.restEncoder,o)),e=i.id.client,o=0,n=0!==i.id.clock),i.constructor===Yo&&(n=!0),n||(o=i.id.clock+i.length);0!==o&&(t++,V(s.restEncoder,e),V(s.restEncoder,o));const l=U();return V(l,t),((t,e)=>{z(t,T(e))})(l,s.restEncoder),s.restEncoder=l,s.toUint8Array()}return V(s.restEncoder,0),s.toUint8Array()},or=(t,e=Le)=>{const n=new e(it(t)),s=new tr(n,!0),r=Ft();let i=-1,o=0,l=0;for(let t=s.curr;null!==t;t=s.next()){const e=t.id;i===e.client&&o+l===e.clock?l+=t.length:(i>=0&&r.add(i,o,l),i=e.client,o=e.clock,l=t.length)}i>=0&&r.add(i,o,l);return{inserts:r,deletes:zt(n)}},lr=(t,e)=>{if(t.constructor===yo){const{client:n,clock:s}=t.id;return new yo(tn(n,s+e),t.length-e)}if(t.constructor===Yo){const{client:n,clock:s}=t.id;return new Yo(tn(n,s+e),t.length-e)}{const n=t,{client:s,clock:r}=n.id;return new $o(tn(s,r+e),null,tn(s,r+e-1),null,n.rightOrigin,n.parent,n.parentSub,n.content.splice(e))}},cr=(t,e=Le,n=Te)=>{if(1===t.length)return t[0];const s=t.map(t=>new e(it(t)));let r=s.map(t=>new tr(t,!0)),i=null;const o=new n,l=new sr(o);for(;r=r.filter(t=>null!==t.curr),r.sort((t,e)=>{if(t.curr.id.client===e.curr.id.client){const n=t.curr.id.clock-e.curr.id.clock;return 0===n?t.curr.constructor===e.curr.constructor?0:t.curr.constructor===Yo?1:-1:n}return e.curr.id.client-t.curr.id.client}),0!==r.length;){const t=r[0],e=t.curr.id.client;if(null!==i){let n=t.curr,s=!1;for(;null!==n&&n.id.clock+n.length<=i.struct.id.clock+i.struct.length&&n.id.client>=i.struct.id.client;)n=t.next(),s=!0;if(null===n||n.id.client!==e||s&&n.id.clock>i.struct.id.clock+i.struct.length)continue;if(e!==i.struct.id.client)ur(l,i.struct,i.offset),i={struct:n,offset:0},t.next();else if(i.struct.id.clock+i.struct.length<n.id.clock)if(i.struct.constructor===Yo)i.struct.length=n.id.clock+n.length-i.struct.id.clock;else{ur(l,i.struct,i.offset);const t=n.id.clock-i.struct.id.clock-i.struct.length;i={struct:new Yo(tn(e,i.struct.id.clock+i.struct.length),t),offset:0}}else{const e=i.struct.id.clock+i.struct.length-n.id.clock;e>0&&(i.struct.constructor===Yo?i.struct.length-=e:n=lr(n,e)),i.struct.mergeWith(n)||(ur(l,i.struct,i.offset),i={struct:n,offset:0},t.next())}}else i={struct:t.curr,offset:0},t.next();for(let n=t.curr;null!==n&&n.id.client===e&&n.id.clock===i.struct.id.clock+i.struct.length&&n.constructor!==Yo;n=t.next())ur(l,i.struct,i.offset),i={struct:n,offset:0}}null!==i&&(ur(l,i.struct,i.offset),i=null),dr(l);const c=s.map(t=>zt(t)),h=Lt(c);return Jt(o,h),o.toUint8Array()},hr=(t,e,n=Le,s=Te)=>{const r=He(e),i=new s,o=new sr(i),l=new n(it(t)),c=new tr(l,!1);for(;c.curr;){const t=c.curr,e=t.id.client,n=r.get(e)||0;if(c.curr.constructor!==Yo)if(t.id.clock+t.length>n)for(ur(o,t,k(n-t.id.clock,0)),c.next();c.curr&&c.curr.id.client===e;)ur(o,c.curr,0),c.next();else for(;c.curr&&c.curr.id.client===e&&c.curr.id.clock+c.curr.length<=n;)c.next();else c.next()}dr(o);const h=zt(l);return Jt(i,h),i.toUint8Array()},ar=t=>{t.written>0&&(t.clientStructs.push({written:t.written,restEncoder:T(t.encoder.restEncoder)}),t.encoder.restEncoder=U(),t.written=0)},ur=(t,e,n)=>{t.written>0&&t.currClient!==e.id.client&&ar(t),0===t.written&&(t.currClient=e.id.client,t.encoder.writeClient(e.id.client),V(t.encoder.restEncoder,e.id.clock+n)),e.write(t.encoder,n,0),t.written++},dr=t=>{ar(t);const e=t.encoder.restEncoder;V(e,t.clientStructs.length);for(let n=0;n<t.clientStructs.length;n++){const s=t.clientStructs[n];V(e,s.written),z(e,s.restEncoder)}},gr=(t,e,n,s)=>{const r=new n(it(t)),i=new tr(r,!1),o=new s,l=new sr(o);for(let t=i.curr;null!==t;t=i.next())ur(l,e(t),0);dr(l);const c=zt(r);return Jt(o,c),o.toUint8Array()},fr=({formatting:t=!0,subdocs:n=!0,yxml:r=!0}={})=>{let i=0;const o=e(),l=e(),c=e(),h=e();return h.set(null,null),e=>{switch(e.constructor){case yo:case Yo:return e;case $o:{const a=e,u=a.content;switch(u.constructor){case _o:break;case Fo:if(r){const t=u.type;t instanceof po&&(t.nodeName=s(l,t.nodeName,()=>"node-"+i)),t instanceof ko&&(t.hookName=s(l,t.hookName,()=>"hook-"+i))}break;case Ao:{const t=u;t.arr=t.arr.map(()=>i);break}case bo:u.content=new Uint8Array([i]);break;case Co:{const t=u;n&&(t.opts={},t.doc.guid=i+"");break}case vo:u.embed={};break;case Eo:{const e=u;t&&(e.key=s(c,e.key,()=>i+""),e.value=s(h,e.value,()=>({i:i})));break}case Do:{const t=u;t.arr=t.arr.map(()=>i);break}case xo:{const t=u;t.str=L(i%10+"",t.str.length);break}default:et()}return a.parentSub&&(a.parentSub=s(o,a.parentSub,()=>i+"")),i++,e}default:et()}}},pr=t=>gr(t,ge,Le,Ue);class kr{constructor(){this.next=null,this.prev=null}}class wr{constructor(){this.start=null,this.end=null,this.len=0}*[Symbol.iterator](){let t=this.start;for(;t;)yield t,t=t.next}forEach(t){Cr(this,t)}[yt](t){let e=this.start,n=t.start;for(;e&&n;){if(!bt(e,n))return!1;e=e.next,n=n.next}return e===n}}const mr=(t,e)=>{const n=e.prev,s=e.next;return n?n.next=s:t.start=s,s?s.prev=n:t.end=n,t.len--,e},yr=mr,br=(t,e,n,s)=>{if(null!=e&&e.next!==n)throw et();e?e.next=s:t.start=s,n?n.prev=s:t.end=s,s.prev=e,s.next=n,t.len++},_r=(t,e)=>br(t,t.end,null,e),Sr=t=>t.end?yr(t,t.end):null,Cr=(t,e)=>{let n=t.start;for(;n;)e(n),n=n.next},vr=new Uint8Array([1,94,109,166,228,6,222,102,239,27,128,184,13,50,112,169,199]),Er=new Map;class Dr{constructor(t){this.m=t,this.blen=t.byteLength,this.bs=new Uint8Array(this.blen),this.cache=(t=>s(Er,ve(t),()=>{const e=t.byteLength,n=new Uint8Array(256*e);n.set(t,e);for(let s=1;s<8;s++){const r=De(t,s),i=1<<s;for(let t=0;t<i;t++){const s=i|t,o=s^r[0];for(let t=0;t<e;t++)n[s*e+t]=n[o*e+t]^r[t]}}return n}))(t),this.bpos=0}write(t){this.bs[this.bpos]=t,this.bpos=(this.bpos+1)%this.blen;const e=this.bs[this.bpos];for(let t=0;t<this.blen;t++)this.bs[(this.bpos+t)%this.blen]^=this.cache[e*this.blen+t]}getFingerprint(){const t=new Uint8Array(this.blen-1);for(let e=0;e<t.byteLength;e++)t[e]=this.bs[(this.bpos+e+1)%this.blen];return t}}const Ir=(t,e)=>{const n=new Dr(t);for(let t=0;t<e.length;t++)n.write(e[t]);return n.getFingerprint()},Ar=$n({insert:Zn(gs).optional,insertAt:us.optional,delete:Zn(gs).optional,deleteAt:us.optional,format:Yn(gs,Zn(gs)).optional,formatAt:us.optional});is($n({type:Rn("insert"),value:cs,prevValue:cs.optional,attribution:Ar.optional}),$n({type:Rn("modify"),value:cs}),$n({type:Rn("delete"),prevValue:cs.optional,attribution:Ar.optional}));const xr=t=>null==t?t:{...t},Lr=t=>Gr.check(t)?t.done():t;class Or extends kr{constructor(t,e,n){super(),this.insert=t,this.format=e,this.attribution=n,this._fingerprint=null}_updateInsert(t){this.insert=t,this._fingerprint=null}get type(){return"insert"}get length(){return this.insert.length}get fingerprint(){return this._fingerprint||(this._fingerprint=ve(M(t=>{V(t,0),J(t,this.insert),W(t,this.format)})))}_splice(t,e){return this._fingerprint=null,this.insert=this.insert.slice(0,t)+this.insert.slice(t+e),this}toJSON(){const{insert:t,format:e,attribution:n}=this;return se({type:"insert",insert:t},null!=e?{format:e}:{},null!=n?{attribution:n}:{})}[yt](t){return fe(this.insert,t.insert)&&fe(this.format,t.format)&&fe(this.attribution,t.attribution)}clone(t=0,e=this.length){return new Or(this.insert.slice(t,e),xr(this.format),xr(this.attribution))}}class Ur extends kr{constructor(t,e,n){super(),this.insert=t,this.format=e,this.attribution=n,this._fingerprint=null}_updateInsert(t){this.insert=t,this._fingerprint=null}get type(){return"insert"}get length(){return this.insert.length}_modValue(t){let e=this.insert[t];return this._fingerprint=null,Gr.expect(e),e.isDone?(this.insert[t]=e=$r(e),e):e}get fingerprint(){return this._fingerprint||(this._fingerprint=ve(M(t=>{V(t,1),V(t,this.insert.length),this.insert.forEach(e=>{Gr.check(e)?(R(t,0),J(t,e.fingerprint)):(R(t,1),W(t,e))}),W(t,this.format)})))}_splice(t,e){return this._fingerprint=null,this.insert.splice(t,e),this}toJSON(){const{insert:t,format:e,attribution:n}=this;return se({type:"insert",insert:t.map(t=>Gr.check(t)?t.toJSON():t)},e?{format:e}:{},null!=n?{attribution:n}:{})}[yt](t){return fe(this.insert,t.insert)&&fe(this.format,t.format)&&fe(this.attribution,t.attribution)}clone(t=0,e=this.length){return new Ur(this.insert.slice(t,e).map(Lr),xr(this.format),xr(this.attribution))}}class Mr extends kr{constructor(t){super(),this.delete=t,this.prevValue=null,this._fingerprint=null}get type(){return"delete"}get length(){return 0}get fingerprint(){return this._fingerprint||(this._fingerprint=ve(M(t=>{V(t,2),V(t,this.delete)})))}_splice(t,e){return this.prevValue=this.prevValue?.slice(t,e)||null,this._fingerprint=null,this.delete-=e,this}toJSON(){return{delete:this.delete}}[yt](t){return this.delete===t.delete}clone(t=0,e=this.delete){return new Mr(e-t)}}class Tr extends kr{constructor(t,e,n){super(),this.retain=t,this.format=e,this.attribution=n,this._fingerprint=null}get type(){return"retain"}get length(){return this.retain}get fingerprint(){return this._fingerprint||(this._fingerprint=ve(M(t=>{V(t,3),V(t,this.retain),W(t,this.format)})))}_splice(t,e){return this.retain-=e,this._fingerprint=null,this}toJSON(){const{retain:t,format:e,attribution:n}=this;return se({type:"retain",retain:t},e?{format:e}:{},null!=n?{attribution:n}:{})}[yt](t){return this.retain===t.retain&&fe(this.format,t.format)&&fe(this.attribution,t.attribution)}clone(t=0,e=this.retain){return new Tr(e-t,xr(this.format),xr(this.attribution))}}class Nr extends kr{constructor(t,e,n){super(),this.value=t,this.format=e,this.attribution=n,this._fingerprint=null}get type(){return"modify"}get length(){return 1}get _modValue(){const t=this.value;return this._fingerprint=null,t.isDone?this.value=$r(t):t}get fingerprint(){return this._fingerprint||(this._fingerprint=ve(M(t=>{V(t,4),J(t,this.value.fingerprint),W(t,this.format)})))}_splice(t,e){return this}toJSON(){const{value:t,attribution:e,format:n}=this;return se({type:"modify",value:t.toJSON()},n?{format:n}:{},null!=e?{attribution:e}:{})}[yt](t){return this.value[yt](t.value)&&fe(this.format,t.format)&&fe(this.attribution,t.attribution)}clone(){return new Nr(this.value.done(),xr(this.format),xr(this.attribution))}}class Rr{constructor(t,e,n,s){this.key=t,this.value=e,this.prevValue=n,this.attribution=s,this._fingerprint=null}get type(){return"insert"}get _modValue(){const t=this.value;return this._fingerprint=null,Gr.check(t)&&t.isDone?this.value=$r(t):t}get fingerprint(){return this._fingerprint||(this._fingerprint=ve(M(t=>{V(t,5),W(t,this.key),Gr.check(this.value)?(R(t,0),J(t,this.value.fingerprint)):(R(t,1),W(t,this.value))})))}toJSON(){const t=this.value,e=this.prevValue,n=this.attribution;return se({type:this.type,value:Gr.check(t)?t.toJSON():t},null!=n?{attribution:n}:{},void 0!==e?{prevValue:e}:{})}[yt](t){return this.key===t.key&&fe(this.value,t.value)&&fe(this.attribution,t.attribution)}clone(){return new Rr(this.key,Lr(this.value),Lr(this.prevValue),xr(this.attribution))}}class Vr{constructor(t,e,n){this.key=t,this.prevValue=e,this.attribution=n,this._fingerprint=null}get value(){}get type(){return"delete"}get fingerprint(){return this._fingerprint||(this._fingerprint=ve(M(t=>{V(t,6),W(t,this.key)})))}toJSON(){const{type:t,attribution:e,prevValue:n}=this;return se({type:t},null!=e?{attribution:e}:{},void 0!==n?{prevValue:n}:{})}[yt](t){return this.key===t.key&&fe(this.attribution,t.attribution)}clone(){return new Vr(this.key,Lr(this.prevValue),xr(this.attribution))}}class Fr{constructor(t,e){this.key=t,this.value=e,this._fingerprint=null}get type(){return"modify"}get fingerprint(){return this._fingerprint||(this._fingerprint=ve(M(t=>{V(t,7),W(t,this.key),J(t,this.value.fingerprint)})))}get _modValue(){return this._fingerprint=null,this.value.isDone&&(this.value=$r(this.value)),this.value}toJSON(){return{type:this.type,value:this.value.toJSON()}}[yt](t){return this.key===t.key&&this.value[yt](t.value)}clone(){return new Fr(this.key,this.value.done())}}const Pr=Tn(t=>null!=t&&(t.constructor===Mr||t.constructor===Vr)),jr=Tn(t=>null!=t&&(t.constructor===Rr||t.constructor===Ur)),Jr=Un(Or),zr=Un(Tr),Br=Tn(t=>null!=t&&(t.constructor===Fr||t.constructor===Nr));is(jr,Pr,Jr,Br);class Hr{constructor(t,e){this.name=t||null,this.$schema=e||null,this.attrs={*[Symbol.iterator](){for(const t in this)yield this[t]}},this.children=new wr,this.childCnt=0,this.origin=null,this._fingerprint=null,this.isDone=!1}get fingerprint(){return this._fingerprint||(this._fingerprint=ve(M(t=>{W(t,this.name);const e=[];for(const t of this.attrs)e.push(t.key);e.sort((t,e)=>{const n=gs.check(t),s=gs.check(e);return n&&s?t.localeCompare(e):n?1:s?-1:t-e}),V(t,e.length);for(const n of e)J(t,this.attrs[n].fingerprint);V(t,this.children.len);for(const e of this.children)J(t,e.fingerprint);return ve(Ir(vr,T(t)))})))}isEmpty(){return le(this.attrs)&&null===this.children.start}toJSON(){const t=this.name,e={},n=[];for(const t of this.attrs)e[t.key]=t.toJSON();return this.children.forEach(t=>{n.push(t.toJSON())}),se({type:"delta"},null!=t?{name:t}:{},le(e)?{}:{attrs:e},n.length>0?{children:n}:{})}equals(t){return this[yt](t)}[yt](t){return this.name===t.name&&fe(this.attrs,t.attrs)&&fe(this.children,t.children)&&this.childCnt===t.childCnt}slice(t=0,e=this.childCnt){const n=new Yr(this.name,this.$schema);n.origin=this.origin;for(const t of this.attrs)n.attrs[t.key]=t.clone();const s=e-t;let r=s,i=this.children.start,o=0;for(;t>0&&null!=i;)i.length<=t?(t-=i.length,i=i.next):(o=t,t=0);if(o>0&&i){const t=i.clone(o,o+p(r,i.length-o));_r(n.children,t),r-=t.length,i=i.next}for(;null!=i&&i.length<=r;)_r(n.children,i.clone()),i=i.next;return null!=i&&r>0&&_r(n.children,i.clone(0,r)),n.childCnt=s-r,n}done(t=!0){if(!this.isDone){this.isDone=t;const e=this.children;for(let t=e.end;null!==t&&zr.check(t)&&null==t.format&&null==t.attribution;t=e.end)this.childCnt-=t.length,Sr(e)}return this}}const $r=t=>t.slice(0,t.childCnt),Wr=(t,e)=>{const n=e.prev;n?.constructor===e.constructor&&(Pr.check(e)||Br.check(e)||fe(e.format,n.format)&&fe(e.attribution,n.attribution))&&(jr.check(e)?n.insert.push(...e.insert):zr.check(e)?n.retain+=e.retain:Pr.check(e)?n.delete+=e.delete:Jr.check(e)?n._updateInsert(n.insert+e.insert):et(),mr(t,e))},Kr=t=>{if(t.isDone)throw Q("Readonly Delta can't be modified");t._fingerprint=null};class Yr extends Hr{constructor(t,e){super(t,e),this.usedAttributes=null,this.usedAttribution=null}useAttribution(t){return Kr(this),this.usedAttribution=t,this}useAttributes(t){return Kr(this),this.usedAttributes=t,this}updateUsedAttributes(t,e){return Kr(this),null==e?(this.usedAttributes=se({},this.usedAttributes),delete this.usedAttributes?.[t],le(this.usedAttributes)&&(this.usedAttributes=null)):fe(this.usedAttributes?.[t],e)||(this.usedAttributes=se({},this.usedAttributes),this.usedAttributes[t]=e),this}updateUsedAttribution(t,e){return Kr(this),null==e?(this.usedAttribution=se({},this.usedAttribution),delete this.usedAttribution?.[t],le(this.usedAttribution)&&(this.usedAttribution=null)):fe(this.usedAttribution?.[t],e)||(this.usedAttribution=se({},this.usedAttribution),this.usedAttribution[t]=e),this}insert(t,e=null,n=null){Kr(this);const s=Xr(this.usedAttributes,e),r=Xr(this.usedAttribution,n),i=t=>(s===t.format||fe(s,t.format))&&(r===t.attribution||fe(r,t.attribution)),o=this.children.end;return gs.check(t)?(Jr.check(o)&&i(o)?o._updateInsert(o.insert+t):t.length>0&&_r(this.children,new Or(t,le(s)?null:s,le(r)?null:r)),this.childCnt+=t.length):a(t)&&(jr.check(o)&&i(o)?(o.insert.push(...t),o._fingerprint=null):t.length>0&&_r(this.children,new Ur(t,le(s)?null:s,le(r)?null:r)),this.childCnt+=t.length),this}modify(t,e=null,n=null){Kr(this);const s=Xr(this.usedAttributes,e),r=Xr(this.usedAttribution,n);return _r(this.children,new Nr(t,le(s)?null:s,le(r)?null:r)),this.childCnt+=1,this}retain(t,e=null,n=null){Kr(this);const s=Xr(this.usedAttributes,e),r=Xr(this.usedAttribution,n),i=this.children.end;return i instanceof Tr&&fe(s,i.format)&&fe(r,i.attribution)?i.retain+=t:t>0&&_r(this.children,new Tr(t,s,r)),this.childCnt+=t,this}delete(t){Kr(this);const e=this.children.end;return e instanceof Mr?e.delete+=t:t>0&&_r(this.children,new Mr(t)),this.childCnt+=t,this}set(t,e,n=null,s){return Kr(this),this.attrs[t]=new Rr(t,e,s,Xr(this.usedAttribution,n)),this}setMany(t,e=null){Kr(this);for(const n in t)this.set(n,t[n],e);return this}unset(t,e=null,n){return Kr(this),this.attrs[t]=new Vr(t,n,Xr(this.usedAttribution,e)),this}update(t,e){return Kr(this),this.attrs[t]=new Fr(t,e),this}apply(t){Kr(this),this.$schema?.expect(t);for(let e of t.attrs){const t=this.attrs[e.key];Br.check(e)?Gr.check(t?.value)?t._modValue.apply(e.value):this.attrs[e.key]=e.clone():(e=e.clone(),e.prevValue=t?.value,this.attrs[e.key]=e)}let e=this.children.start,n=0;const s=[],r=t=>(t&&s.push(t),t);return t.children.forEach(t=>{if(Jr.check(t)||jr.check(t)){if(0===n)br(this.children,null==e?this.children.end:e.prev,e,r(t.clone()));else{null==e&&et();const s=r(e.clone(n));e._splice(n,e.length-n),br(this.children,e,e.next||null,s),br(this.children,e,s||null,r(t.clone())),n=0}this.childCnt+=t.insert.length}else if(zr.check(t)){let s=t.length;for(;null!=e&&e.length-n<=s;)s-=e.length-n,e=e?.next||null,n=0;null!=e?n+=s:(_r(this.children,r(new Tr(s,t.format,t.attribution))),this.childCnt+=s)}else if(Pr.check(t)){let s=t.delete;for(;s>0;){if(null==e){_r(this.children,r(new Mr(s))),this.childCnt+=s;break}if(e instanceof Mr){const t=e.length-n;t>=s?(n=0,e=e.next):n+=s,s-=t}else{const t=p(e.length-n,s);this.childCnt-=t,e.length===t?(n=0,r(e.next),mr(this.children,e)):0===n?(n=0,e._splice(0,t)):n+t===e.length?(e._splice(n,t),n=0,e=e.next):e._splice(n,t),s-=t}}}else if(Br.check(t)){if(null==e)return _r(this.children,t.clone()),void(this.childCnt+=1);if(Br.check(e))e._modValue.apply(t.value);else if(jr.check(e))e._modValue(n).apply(t.value);else if(zr.check(e)){if(n>0){const t=r(e.clone(0,n));e._splice(0,n),br(this.children,e.prev,e,t),n=0}br(this.children,e.prev,e,r(t.clone())),1===e.length?mr(this.children,e):(e._splice(0,1),r(e))}else Pr.check(e)||et()}else et()}),s.forEach(t=>{t.prev?.next===t&&(Wr(this.children,t),t.next&&Wr(this.children,t.next))}),this}rebase(t,e){Kr(this);for(const n of this.attrs)if(jr.check(n))jr.check(t.attrs[n.key])&&!e&&delete this.attrs[n.key];else if(Pr.check(n)){const e=t.attrs[n.key];jr.check(e)&&delete this.attrs[e.key]}else if(Br.check(n)){const s=t.attrs[n.key];null==s||(Br.check(s)?n._modValue.rebase(s.value,e):delete this.attrs[s.key])}let n=this.children.start,s=0,r=t.children.start,i=0;for(;null!=n&&null!=r;){if(jr.check(n)||Jr.check(n))jr.check(r)||Br.check(r)||Jr.check(r)?e?s=n.length:(br(this.children,n.prev,n,new Tr(r.length,null,null)),this.childCnt+=r.length,i=r.length):s=n.length;else if(Br.check(n))jr.check(r)||Jr.check(r)?(br(this.children,n.prev,n,new Tr(r.length,null,null)),this.childCnt+=r.length,i=r.length):(Br.check(r)?n.value.rebase(r,e):Pr.check(r)&&(mr(this.children,n),this.childCnt-=1),s+=1,i+=1);else{const t=p(n.length-s,r.length-i);if(zr.check(r)||Br.check(r))s+=t,i+=t;else if(Pr.check(r))zr.check(n)?n.retain-=t:Pr.check(n)&&(n.delete-=t),this.childCnt-=t;else{if(s>0){const t=n.clone(s);br(this.children,n.prev,n,t),n._splice(s,n.length-s),s=0}br(this.children,n.prev,n,new Tr(r.length,null,null)),this.childCnt+=r.length,i=r.length}}s>=n.length&&(n=n.next,s=0),i>=r.length&&(r=r.next,i=0)}return this}rebaseOnInverse(t,e){return Kr(this),console.info("method rebaseOnInverse unimplemented"),this}}const Gr=es(Hr),Xr=(t,e)=>le(t)?e:le(e)?t:se({},t,e),qr=(t,e,n)=>{const s=gs.check(t)?t:null,r=ns.check(t)?t:ns.check(e)?e:null,i=new Yr(s,r);return Wn.check(e)&&i.setMany(e),i};((...t)=>{(({name:t,attrs:e,children:n,text:s,recursive:r})=>{let i=null==n?Bn:Zn(ys(n));const o=null==t?cs:ys(t),l=null==e?$n({}):Gn.check(e)?e:ys(e).partial,c=es(Hr,t=>{if(!o.check(t.name)||((t,e)=>{for(const n in t)if(e(t[n],n))return!0;return!1})(t.attrs,(t,e)=>jr.check(t)&&!l.check({[e]:t.value})))return!1;for(const e of t.children)if(jr.check(e)&&!i.check(e.insert))return!1;return!0});r&&(i=null==n?Zn(c):Zn(ys(n),c))})({children:is(...t),text:!0})})();class Zr{constructor(t,e,n){this.target=t,this.currentTarget=t,this.transaction=e,this._delta=null,this._deltaDeep=null,this._path=null,this.childListChanged=!1,this.keysChanged=new Set,n?.forEach(t=>{null===t?this.childListChanged=!0:this.keysChanged.add(t)})}get path(){return this._path||(this._path=Qr(this.currentTarget,this.target))}deletes(t){return this.transaction.deleteSet.hasId(t.id)}adds(t){return this.transaction.insertSet.hasId(t.id)}getDelta(t=bi,{deep:e}={}){const n=Lt([Tt(this.transaction.insertSet,this.transaction.deleteSet),Tt(this.transaction.deleteSet,this.transaction.insertSet)]),s=e?this.transaction.changedParentTypes:null;return this.target.getContent(t,{itemsToRender:n,retainDeletes:!0,renderAttrs:this.keysChanged,renderChildren:e||this.childListChanged,deletedItems:this.transaction.deleteSet,deep:!!e,modified:s})}get delta(){return this._delta??(this._delta=this.getDelta().done())}get deltaDeep(){return this._deltaDeep??(this._deltaDeep=this.getDelta(bi,{deep:!0}))}}const Qr=(t,e)=>{const n=[];for(;null!==e._item&&e!==t;){if(null!==e._item.parentSub)n.unshift(e._item.parentSub);else{let t=0,s=e._item.parent._start;for(;s!==e._item&&null!==s;)!s.deleted&&s.countable&&(t+=s.length),s=s.right;n.unshift(t)}e=e._item.parent}return n},ti=(t,e)=>{const n=new si,s=ht(t.restDecoder);for(let r=0;r<s;r++){const s=ht(t.restDecoder),r=new Array(s),i=t.readClient();let o=ht(t.restDecoder);n.clients.set(i,new ni(r));for(let n=0;n<s;n++){const s=t.readInfo();switch(31&s){case 0:{const e=t.readLen();r[n]=new yo(tn(i,o),e),o+=e;break}case 10:{const e=ht(t.restDecoder);r[n]=new Yo(tn(i,o),e),o+=e;break}default:{const l=!(192&s),c=new $o(tn(i,o),null,(s&y)===y?t.readLeftID():null,null,(s&m)===m?t.readRightID():null,l?t.readParentInfo()?e.get(t.readString()):t.readLeftID():null,!l||32&~s?null:t.readString(),Wo(t,s));r[n]=c,o+=c.length}}}}return n},ei=(t,e)=>{e.clients.forEach((e,n)=>{const s=t.clients.get(n)?.refs;if(null!=s){const t=s[0],r=s[s.length-1],i=e.getIds();for(let e=0;e<i.length;e++){const o=i[e];let l=0;if(o.clock>=r.id.clock+r.length)continue;o.clock>t.id.clock&&(l=_n(null,s,o.clock));let c=s.length;if(!(o.clock+o.len<=t.id.clock)&&(o.clock+o.len<r.id.clock+r.length&&(c=_n(null,s,o.clock+o.len)),l<c)){s[l]=new Yo(new Ze(n,o.clock),o.len);const t=c-l;t>1&&s.splice(l+1,t-1)}}}})};class ni{constructor(t){this.i=0,this.refs=t}}class si{constructor(){this.clients=e()}}class ri{constructor(t,e){this.name=t,this.val=e}hash(){const t=U();return J(t,this.name),W(t,this.val),ve(Ir(vr,T(t)))}}const ii=(t,e)=>t.find(t=>t===e),oi=(t,e)=>t.length===e.length&&t.every(t=>ii(e,t)),li=(t,e)=>t.concat(e.filter(e=>!ii(t,e)));class ci{constructor(t,e,n){this.clock=t,this.len=e,this.attrs=n}copyWith(t,e){return new ci(t,e,this.attrs)}}const hi=(t,e,n)=>new ci(t,e,n);class ai{constructor(t){this.sorted=!1,this._ids=t}copy(){return new ai(this._ids.slice())}add(t,e,n){0!==e&&(this.sorted=!1,this._ids.push(new ci(t,e,n)))}getIds(){const t=this._ids;if(!this.sorted){this.sorted=!0,t.sort((t,e)=>t.clock-e.clock);for(let e=0;e<t.length-1;){const n=t[e],s=t[e+1];if(n.clock<s.clock){if(n.clock+n.len>s.clock){const r=s.clock-n.clock;t[e]=new ci(n.clock,r,n.attrs),t.splice(e+1,0,new ci(s.clock,n.len-r,n.attrs))}e++;continue}const r=n.len>s.len?n:s,i=n.len<s.len?n.len:s.len;t[e]=new ci(n.clock,i,li(n.attrs,s.attrs)),n.len===s.len?t.splice(e+1,1):(t[e+1]=new ci(n.clock+i,r.len-i,r.attrs),u(t,e+1,(t,e)=>t.clock-e.clock)),0===i&&e++}for(;t.length>0&&0===t[0].len;)t.splice(0,1);let e,n;for(e=1,n=1;e<t.length;e++){const s=t[n-1],r=t[e];s.clock+s.len===r.clock&&oi(s.attrs,r.attrs)?t[n-1]=new ci(s.clock,s.len+r.len,s.attrs):0!==r.len&&(n<e&&(t[n]=r),n++)}t.length=0===t.length?0:0===t[n-1].len?n-1:n}return t}}const ui=(t,e)=>{const n=pi();e=fi(n,e);const s=[];return e.forEach(t=>{ii(s,t)||s.push(t)}),t.clients.forEach((t,e)=>{const r=new ai(t.getIds().map(t=>new ci(t.clock,t.len,s)));r.sorted=!0,n.clients.set(e,r)}),n};class di{constructor(){this.clients=new Map,this.attrsH=new Map,this.attrs=new Set}forEach(t){this.clients.forEach((e,n)=>{e.getIds().forEach(e=>{t(e,n)})})}hasId(t){return this.has(t.client,t.clock)}has(t,e){const n=this.clients.get(t);return!!n&&null!==At(n.getIds(),e)}sliceId(t,e){return this.slice(t.client,t.clock,e)}slice(t,e,n){const s=this.clients.get(t),r=[];if(s){const t=s.getIds();let i=xt(t,e);if(null!==i){let s=null;for(;i<t.length;){let o=t[i];if(o.clock<e&&(o=new ci(e,o.len-(e-o.clock),o.attrs)),o.clock+o.len>e+n&&(o=new ci(o.clock,e+n-o.clock,o.attrs)),o.len<=0)break;const l=null!=s?s.clock+s.len:e;l<o.clock&&r.push(hi(l,o.clock-l,null)),s=o,r.push(o),i++}}}if(r.length>0){const t=r[r.length-1],s=t.clock+t.len;s<e+n&&r.push(hi(s,e+n-s,null))}else r.push(hi(e,n,null));return r}add(t,e,n,s){if(0===n)return;s=fi(this,s);const r=this.clients.get(t);null==r?this.clients.set(t,new ai([new ci(e,n,s)])):r.add(e,n,s)}delete(t,e,n){Dt(this,t,e,n)}}const gi=t=>{const e=new di,n=ht(t.restDecoder),s=[],r=[];let i=0;for(let o=0;o<n;o++){t.resetDsCurVal();const n=i+ht(t.restDecoder);i=n;const o=ht(t.restDecoder),l=[];for(let e=0;e<o;e++){const e=t.readDsClock(),n=t.readDsLen(),i=[],o=ht(t.restDecoder);for(let e=0;e<o;e++){const e=ht(t.restDecoder);if(e>=s.length){const e=ht(t.restDecoder);e>=r.length&&r.push(ut(t.restDecoder)),s.push(new ri(r[e],ft(t.restDecoder)))}i.push(s[e])}l.push(new ci(e,n,i))}e.clients.set(n,new ai(l))}return s.forEach(t=>{e.attrs.add(t),e.attrsH.set(t.hash(),t)}),e},fi=(t,e)=>e.map(e=>t.attrs.has(e)?e:s(t.attrsH,(t=>{const e=U();return J(e,t.name),W(e,t.val),ve(Ir(vr,T(e)))})(e),()=>(t.attrs.add(e),e))),pi=()=>new di,ki=Ot,wi=(t,e)=>{const n=Mt(t,e);return n.attrs=t.attrs,n.attrsH=t.attrsH,n};$n({insert:Zn(gs).optional,insertedAt:us.optional,delete:Zn(gs).optional,deletedAt:us.optional,format:Yn(gs,Zn(gs)).optional,formatAt:us.optional});const mi=(t,e)=>{if(null==t)return null;const n={};return e?n.delete=Zn(gs).cast([]):n.insert=[],t.forEach(t=>{switch(t.name){case"insert":case"delete":{const e=n;(e[t.name]=e[t.name]??[]).push(t.val);break}default:"_"!==t.name[0]&&(n[t.name]=t.val)}}),n};class yi{constructor(t,e,n,s,r){this.content=t,this.clock=e,this.deleted=n,this.attrs=s,this.render=0!==r&&(1!==r||(!n||null!=s))}}const bi=new class extends d{readContent(t,e,n,s,r,i){s&&!i||t.push(new yi(r,n,s,null,i))}contentLength(t){return t.deleted||!t.content.isCountable()?0:t.length}},_i=(t,e,n,s)=>{const r=bn(t,tn(e,n)),i=n-r.id.clock;let o=r.length>1?r.content.copy():r.content;return i>0&&(o=o.splice(i)),s<o.getLength()&&o.splice(s),o},Si=(t,e,n,s,r)=>{const i=Ft(),o=Ft(),l=e._nextDoc.store,c=new Set;let h=bn(l,n);const a=n===s?h:null==s?null:bn(l,s);for(;null!=h.left;){if(h=h.left,h.content instanceof Eo&&null==h.content.value){h=h.right;break}if(!h.deleted){const t=e.inserts.slice(h.id.client,h.id.clock,h.length);if(t.some(t=>null===t.attrs)){for(let e=t.length-1;e>=0;e--){const n=t[e];if(null==n.attrs)break;i.add(h.id.client,n.clock,n.len)}h=h.right;break}}}let u=!1;t:for(;null!=h;){const n=h.id.client,s=(h.deleted?e.deletes:e.inserts).slice(n,h.id.clock,h.length);if(u||=h===a,h.deleted)for(let l=s.length-1;l>=0;l--){const c=s[l];if((null!=c.attrs||r)&&(o.add(n,c.clock,c.len),r&&i.add(n,c.clock,c.len)),null!=t){const s=Sn(t,tn(n,c.clock));null!=c.attrs&&(s.content=_i(e._prevDocStore,n,c.clock,c.len))}}else{if(h.content instanceof Eo){const{key:t,value:e}=h.content;null==e?c.delete(t):c.add(t)}for(let t=0;t<s.length;t++){const e=s[t];if(null!=e.attrs)i.add(n,e.clock,e.len);else if(u&&0===c.size)break t}}h=h.right}return{inserts:i,deletes:o}};class Ci extends d{constructor(t,e){super();const n=jt(e.store,!1),s=jt(t.store,!1),r=Pt(e.store),i=Pt(t.store);this.inserts=ui(Tt(n,s),[]),this.deletes=ui(Tt(r,i),[]),this._prevDoc=t,this._prevDocStore=t.store,this._nextDoc=e,this._nextBOH=e.on("beforeObserverCalls",t=>{const e=Tt(t.insertSet,s);ki(this.inserts,ui(e,[]));const n=Tt(Tt(t.deleteSet,i),this.inserts);ki(this.deletes,ui(n,[]))}),this._prevBOH=t.on("beforeObserverCalls",t=>{Ut(s,t.insertSet),Ut(i,t.deleteSet),t.insertSet.clients.size<2?t.insertSet.forEach((t,e)=>{this.inserts.delete(e,t.clock,t.len)}):this.inserts=wi(this.inserts,t.insertSet),t.deleteSet.clients.size<2?t.deleteSet.forEach((t,e)=>{this.deletes.delete(e,t.clock,t.len)}):this.deletes=wi(this.deletes,t.deleteSet),this.emit("change",[Tt(Lt([t.insertSet,t.deleteSet]),Nt(t.insertSet,t.deleteSet)),t.origin,t.local])}),this._prevUpdateListener=t.on("update",(t,n)=>{n!==this&&je(e,t)}),this._ndUpdateListener=e.on("update",(e,n,s,r)=>{this.suggestionMode||!r.local||null!=this.suggestionOrigins&&!this.suggestionOrigins.some(t=>t===n)||je(t,e,this)}),this._afterTrListener=e.on("afterTransaction",e=>{if(!this.suggestionMode&&e.local&&(null==this.suggestionOrigins||this.suggestionOrigins.some(t=>t===e.origin))){const n=e.meta.get("attributedDeletes");null!=n&&Gs(t,()=>{const e=new Ue;V(e.restEncoder,0),Jt(e,n),je(t,e.toUint8Array())},this)}}),this.suggestionMode=!0,this.suggestionOrigins=null,this._destroyHandler=e.on("destroy",this.destroy.bind(this)),t.on("destroy",this._destroyHandler)}destroy(){super.destroy(),this._nextDoc.off("destroy",this._destroyHandler),this._prevDoc.off("destroy",this._destroyHandler),this._nextDoc.off("beforeObserverCalls",this._nextBOH),this._prevDoc.off("beforeObserverCalls",this._prevBOH),this._prevDoc.off("update",this._prevUpdateListener),this._nextDoc.off("update",this._ndUpdateListener),this._nextDoc.off("afterTransaction",this._afterTrListener)}acceptChanges(t,e=t){const{inserts:n,deletes:s}=Si(null,this,t,e,!0),r=new Ue;Ve(r,this._nextDoc.store,n),Jt(r,s),je(this._prevDoc,r.toUint8Array())}rejectChanges(t,e=t){this._nextDoc.transact(n=>{const{inserts:s,deletes:r}=Si(n,this,t,e,!1),i=new Ue;Ve(i,this._nextDoc.store,s),Jt(i,r);const o=new Qs(this._nextDoc);o.undoStack.push(new Xs(r,s)),o.undo(),o.destroy()}),this.acceptChanges(t,e)}readContent(t,e,n,s,r,i){const o=(s?this.deletes:this.inserts).slice(e,n,r.getLength());let l=1===o.length?r:r.copy();for(let n=0;n<o.length;n++){const r=o[n];if(null==l||l instanceof _o){if(!i&&null==r.attrs||this.inserts.has(e,r.clock))continue;const t=bn(this._prevDocStore,tn(e,r.clock)),n=r.clock-t.id.clock;l=t.length>1?t.content.copy():t.content,n>0&&(l=l.splice(n))}const c=l,h=c.getLength();h<r.len&&(o.splice(n+1,0,hi(r.clock+h,r.len-h,r.attrs)),r.len=h),l=r.len<h?c.splice(r.len):null,!i&&s&&null==r.attrs||t.push(new yi(c,r.clock,s,r.attrs,i))}}contentLength(t){if(!t.deleted)return t.content.isCountable()?t.length:0;const e=[];return this.readContent(e,t.id.client,t.id.clock,!0,t.content,0),e.reduce((t,e)=>t+(null!=e.attrs&&e.content.isCountable()?e.content.getLength():0),0)}}const vi=t=>({[Symbol.iterator](){return this},next:t}),Ei=(t,e)=>vi(()=>{const{done:n,value:s}=t.next();return{done:n,value:n?void 0:e(s)}}),Di=()=>{js("Invalid access: Add Yjs type to a document before reading data.")};let Ii=0;class Ai{constructor(t,e){t.marker=!0,this.p=t,this.index=e,this.timestamp=Ii++}}const xi=(t,e,n)=>{t.p.marker=!1,t.p=e,e.marker=!0,t.index=n,t.timestamp=Ii++},Li=(t,e)=>{if(null===t._start||0===e||null===t._searchMarker)return null;const n=0===t._searchMarker.length?null:t._searchMarker.reduce((t,n)=>f(e-t.index)<f(e-n.index)?t:n);let s=t._start,r=0;for(null!==n&&(s=n.p,r=n.index,(t=>{t.timestamp=Ii++})(n));null!==s.right&&r<e;){if(!s.deleted&&s.countable){if(e<r+s.length)break;r+=s.length}s=s.right}for(;null!==s.left&&r>e;)s=s.left,!s.deleted&&s.countable&&(r-=s.length);for(;null!==s.left&&s.left.id.client===s.id.client&&s.left.id.clock+s.left.length===s.id.clock;)s=s.left,!s.deleted&&s.countable&&(r-=s.length);return null!==n&&f(n.index-r)<s.parent.length/80?(xi(n,s,r),n):((t,e,n)=>{if(t.length>=80){const s=t.reduce((t,e)=>t.timestamp<e.timestamp?t:e);return xi(s,e,n),s}{const s=new Ai(e,n);return t.push(s),s}})(t._searchMarker,s,r)},Oi=(t,e,n)=>{for(let s=t.length-1;s>=0;s--){const r=t[s];if(n>0){let e=r.p;for(e.marker=!1;e&&(e.deleted||!e.countable);)e=e.left,e&&!e.deleted&&e.countable&&(r.index-=e.length);if(null===e||!0===e.marker){t.splice(s,1);continue}r.p=e,e.marker=!0}(e<r.index||n>0&&e===r.index)&&(r.index=k(e,r.index+n))}};class Ui{constructor(){this._item=null,this._map=new Map,this._start=null,this.doc=null,this._length=0,this._eH=Ye(),this._dEH=Ye(),this._searchMarker=null,this._prelim=null}get change(){return qr()}get parent(){return this._item?this._item.parent:null}_integrate(t,e){this.doc=t,this._item=e,this._prelim&&(this.applyDelta(this._prelim),this._prelim=null)}_copy(){return new this.constructor}clone(){throw tt()}_write(t){}get _first(){let t=this._start;for(;null!==t&&t.deleted;)t=t.right;return t}_callObserver(t,e){((t,e,n)=>{const r=t,i=e.changedParentTypes;for(;s(i,t,()=>[]).push(n),null!==t._item;)t=t._item.parent;qe(r._eH,n,e)})(this,t,new Zr(this,t,e)),!t.local&&this._searchMarker&&(this._searchMarker.length=0)}observe(t){return Ge(this._eH,t),t}observeDeep(t){return Ge(this._dEH,t),t}unobserve(t){Xe(this._eH,t)}unobserveDeep(t){Xe(this._dEH,t)}toJSON(){}getContent(t=bi,e={}){const{itemsToRender:n=null,retainInserts:s=!1,retainDeletes:r=!1,renderAttrs:i=null,renderChildren:o=!0,deletedItems:l=null,modified:c=null,deep:h=!1}=e,a=qr(this.nodeName||null);if(Yi(a,this,i,t,h,c,l,n),o){let i={},o=!1,l={},u=!1;const d={},g={},f=[];for(let p=this._start;null!==p;f.length=0){if(null!=n)for(;null!==p&&f.length<50;p=p.right){const e=n.slice(p.id.client,p.id.clock,p.length);let s=e.length>1?p.content.copy():p.content;for(let n=0;n<e.length;n++){const r=e[n],i=s;n!==e.length-1&&(s=s.splice(r.len)),t.readContent(f,p.id.client,r.clock,p.deleted,i,r.exists?2:0)}}else for(;null!==p&&f.length<50;p=p.right)t.readContent(f,p.id.client,p.id.clock,p.deleted,p.content,1);for(let n=0;n<f.length;n++){const p=f[n],k=p.render&&(!p.deleted||null!=p.attrs),w=p.render&&p.deleted,m=!(p.render||p.deleted&&null==p.attrs),y=k||p.content.constructor===Eo?mi(p.attrs,p.deleted):null;switch(p.content.constructor){case _o:w&&a.delete(p.content.getLength());break;case xo:k?(a.usedAttributes=i,o=!0,(p.deleted?r:s)?a.retain(p.content.str.length,null,y??{}):a.insert(p.content.str,null,y)):w?a.delete(p.content.getLength()):m&&(a.usedAttributes=l,u=!0,a.retain(p.content.getLength()));break;case vo:case Ao:case Do:case Fo:case bo:k?(a.usedAttributes=i,o=!0,(p.deleted?r:s)?a.retain(p.content.getLength(),null,y??{}):h&&p.content.constructor===Fo?a.insert([p.content.type.getContent(t,{...e,renderChildren:!0,renderAttrs:null})],null,y):a.insert(p.content.getContent(),null,y)):w?a.delete(1):m&&(p.content.constructor===Fo&&c?.has(p.content.type)?a.modify(p.content.type.getContent(t,e)):(a.usedAttributes=l,u=!0,a.retain(1)));break;case Eo:{const{key:t,value:e}=p.content,n=i[t]??null;if(null==y||!p.deleted&&he(d,t)||(d[t]=p.deleted?e:n),(k||w)&&(o&&(i=se({},i),o=!1),u&&(u=!1,l=se({},l))),k||w?p.deleted?Mi(e,n)||(Mi(n,g[t]??null)&&void 0!==l[t]?delete l[t]:l[t]=n,g[t]=e):(Mi(e,n)||(Mi(e,g[t]??null)?delete l[t]:l[t]=e),null==e?delete i[t]:i[t]=e):m&&!p.deleted&&(o&&(i=se({},i),o=!1),u&&void 0!==l[t]&&(u=!1,l=se({},l)),null==e?delete i[t]:i[t]=e,delete l[t],g[t]=e),null!=y||he(d,t)){const e=se({},a.usedAttribution),n=e.format=se({},e.format??{});if(null==y||Mi(d[t],i[t]??null))delete n[t],delete d[t];else{(n[t]=n[t]?.slice()??[]).push(...(p.deleted?y.delete:y.insert)??[]);const s=p.deleted?y.deletedAt:y.insertedAt;s&&(e.formatAt=s)}if(le(n))a.useAttribution(null);else if(null!=y){const t=p.deleted?y.deletedAt:y.insertedAt;null!=t&&(e.formatAt=t),a.useAttribution(e)}}break}}}}}return a.done(!1)}getContentDeep(t=bi){return this.getContent(t,{deep:!0})}applyDelta(t,e=bi){null==this.doc?(this._prelim||(this._prelim=qr())).apply(t):Gs(this.doc,n=>{const s=new to(null,this._start,0,new Map,e);for(const e of t.children)if(Jr.check(e))lo(n,this,s,e.insert,e.format||{});else if(jr.check(e))for(let t=0;t<e.insert.length;t++){let r=e.insert[t];if(Gr.check(r))if(null!=r.name){const t=new po(r.name);t.applyDelta(r),r=t}else et();lo(n,this,s,r,e.format||{})}else zr.check(e)?s.formatText(n,this,e.retain,e.format||{}):Pr.check(e)?uo(n,s,e.delete):Br.check(e)?((s.right?.content).type.applyDelta(e.value),s.formatText(n,this,1,e.format||{})):et();for(const e of t.attrs)if(jr.check(e))$i(n,this,e.key,e.value);else if(Pr.check(e))Hi(n,this,e.key);else{const t=Wi(this,e.key);t instanceof Ui||et(),t.applyDelta(e.value)}})}}const Mi=(t,e)=>t===e||"object"==typeof t&&"object"==typeof e&&t&&e&&((t,e)=>t===e||oe(t)===oe(e)&&ce(t,(t,n)=>(void 0!==t||he(e,n))&&bt(e[n],t)))(t,e),Ti=(t,e,n)=>{t.doc??Di(),e<0&&(e=t._length+e),n<0&&(n=t._length+n);let s=n-e;const r=[];let i=t._start;for(;null!==i&&s>0;){if(i.countable&&!i.deleted){const t=i.content.getContent();if(t.length<=e)e-=t.length;else{for(let n=e;n<t.length&&s>0;n++)r.push(t[n]),s--;e=0}}i=i.right}return r},Ni=t=>{t.doc??Di();const e=[];let n=t._start;for(;null!==n;){if(n.countable&&!n.deleted){const t=n.content.getContent();for(let n=0;n<t.length;n++)e.push(t[n])}n=n.right}return e},Ri=(t,e)=>{let n=0,s=t._start;for(t.doc??Di();null!==s;){if(s.countable&&!s.deleted){const r=s.content.getContent();for(let s=0;s<r.length;s++)e(r[s],n++,t)}s=s.right}},Vi=(t,e)=>{const n=[];return Ri(t,(s,r)=>{n.push(e(s,r,t))}),n},Fi=t=>{let e=t._start,n=null,s=0;return{[Symbol.iterator](){return this},next:()=>{if(null===n){for(;null!==e&&e.deleted;)e=e.right;if(null===e)return{done:!0,value:void 0};n=e.content.getContent(),s=0,e=e.right}const t=n[s++];return n.length<=s&&(n=null),{done:!1,value:t}}}},Pi=(t,e)=>{t.doc??Di();const n=Li(t,e);let s=t._start;for(null!==n&&(s=n.p,e-=n.index);null!==s;s=s.right)if(!s.deleted&&s.countable){if(e<s.length)return s.content.getContent()[e];e-=s.length}},ji=(t,e,n,s)=>{let r=n;const i=t.doc,o=i.clientID,l=i.store,c=null===n?e._start:n.right;let h=[];const a=()=>{h.length>0&&(r=new $o(tn(o,wn(l,o)),r,r&&r.lastId,c,c&&c.id,e,null,new Ao(h)),r.integrate(t,0),h=[])};s.forEach(n=>{if(null===n)h.push(n);else switch(n.constructor){case Number:case Object:case void 0:case Boolean:case Array:case String:case BigInt:case Date:h.push(n);break;default:switch(a(),n.constructor){case Uint8Array:case ArrayBuffer:r=new $o(tn(o,wn(l,o)),r,r&&r.lastId,c,c&&c.id,e,null,new bo(new Uint8Array(n))),r.integrate(t,0);break;case Zt:r=new $o(tn(o,wn(l,o)),r,r&&r.lastId,c,c&&c.id,e,null,new Co(n)),r.integrate(t,0);break;default:if(!(n instanceof Ui))throw new Error("Unexpected content type in insert operation");r=new $o(tn(o,wn(l,o)),r,r&&r.lastId,c,c&&c.id,e,null,new Fo(n)),r.integrate(t,0)}}}),a()},Ji=()=>Q("Length exceeded!"),zi=(t,e,n,s)=>{if(n>e._length)throw Ji();if(0===n)return e._searchMarker&&Oi(e._searchMarker,n,s.length),ji(t,e,null,s);const r=n,i=Li(e,n);let o=e._start;for(null!==i&&(o=i.p,0===(n-=i.index)&&(o=o.prev,n+=o&&o.countable&&!o.deleted?o.length:0));null!==o;o=o.right)if(!o.deleted&&o.countable){if(n<=o.length){n<o.length&&Sn(t,tn(o.id.client,o.id.clock+n));break}n-=o.length}return e._searchMarker&&Oi(e._searchMarker,r,s.length),ji(t,e,o,s)},Bi=(t,e,n,s)=>{if(0===s)return;const r=n,i=s,o=Li(e,n);let l=e._start;for(null!==o&&(l=o.p,n-=o.index);null!==l&&n>0;l=l.right)!l.deleted&&l.countable&&(n<l.length&&Sn(t,tn(l.id.client,l.id.clock+n)),n-=l.length);for(;s>0&&null!==l;)l.deleted||(s<l.length&&Sn(t,tn(l.id.client,l.id.clock+s)),l.delete(t),s-=l.length),l=l.right;if(s>0)throw Ji();e._searchMarker&&Oi(e._searchMarker,r,-i+s)},Hi=(t,e,n)=>{const s=e._map.get(n);void 0!==s&&s.delete(t)},$i=(t,e,n,s)=>{const r=e._map.get(n)||null,i=t.doc,o=i.clientID;let l;if(null==s)l=new Ao([s]);else switch(s.constructor){case Number:case Object:case Boolean:case Array:case String:case Date:case BigInt:l=new Ao([s]);break;case Uint8Array:l=new bo(s);break;case Zt:l=new Co(s);break;default:if(!(s instanceof Ui))throw new Error("Unexpected content type");l=new Fo(s)}new $o(tn(o,wn(i.store,o)),r,r&&r.lastId,null,null,e,n,l).integrate(t,0)},Wi=(t,e)=>{t.doc??Di();const n=t._map.get(e);return void 0===n||n.deleted?void 0:n.content.getContent()[n.length-1]},Ki=t=>{const e={};return t.doc??Di(),t._map.forEach((t,n)=>{t.deleted||(e[n]=t.content.getContent()[t.length-1])}),e},Yi=(t,e,n,s,r,o,l,c)=>{const h=(e,n)=>{const o=[];s.readContent(o,e.id.client,e.id.clock,e.deleted,e.content,1);const{deleted:h,attrs:a,content:u}=o[o.length-1],d=mi(a,h);let g=i(u.getContent());if(h)(null==c||c.hasId(e.lastId))&&t.unset(n,d,g);else{let o=e;for(;null!==o.left&&l?.hasId(o.left.lastId);o=o.left);const h=o!==e&&c?.hasId(o.lastId)?i(o.content.getContent()):void 0;r&&g instanceof Ui&&(g=g.getContent(s)),t.set(n,g,d,h)}};null==n?e._map.forEach(h):n.forEach(t=>h(e._map.get(t),t))},Gi=(t,e)=>{t.doc??Di();const n=t._map.get(e);return void 0!==n&&!n.deleted},Xi=(t,e)=>{const n={};return t._map.forEach((t,s)=>{let r=t;for(;null!==r&&(!e.sv.has(r.id.client)||r.id.clock>=(e.sv.get(r.id.client)||0));)r=r.left;null!==r&&fn(r,e)&&(n[s]=r.content.getContent()[r.length-1])}),n},qi=t=>{return t.doc??Di(),e=t._map.entries(),n=t=>!t[1].deleted,vi(()=>{let t;do{t=e.next()}while(!t.done&&!n(t.value));return t});var e,n};class Zi extends Ui{constructor(){super(),this._prelimContent=[],this._searchMarker=[]}static from(t){const e=new Zi;return e.push(t),e}_integrate(t,e){super._integrate(t,e),this.insert(0,this._prelimContent),this._prelimContent=null}clone(){const t=new Zi;return t.insert(0,this.toArray().map(t=>t instanceof Ui?t.clone():t)),t}get length(){return this.doc??Di(),this._length}insert(t,e){null!==this.doc?Gs(this.doc,n=>{zi(n,this,t,e)}):this._prelimContent.splice(t,0,...e)}push(t){null!==this.doc?Gs(this.doc,e=>{((t,e,n)=>{let s=(e._searchMarker||[]).reduce((t,e)=>e.index>t.index?e:t,{index:0,p:e._start}).p;if(s)for(;s.right;)s=s.right;ji(t,e,s,n)})(e,this,t)}):this._prelimContent.push(...t)}unshift(t){this.insert(0,t)}delete(t,e=1){null!==this.doc?Gs(this.doc,n=>{Bi(n,this,t,e)}):this._prelimContent.splice(t,e)}get(t){return Pi(this,t)}toArray(){return Ni(this)}getContentDeep(t=bi){return super.getContentDeep(t)}slice(t=0,e=this.length){return Ti(this,t,e)}toJSON(){return this.map(t=>t instanceof Ui?t.toJSON():t)}map(t){return Vi(this,t)}forEach(t){Ri(this,t)}[Symbol.iterator](){return Fi(this)}_write(t){t.writeTypeRef(Oo)}}class Qi extends Ui{constructor(t){super(),this._prelimContent=null,this._prelimContent=void 0===t?new Map:new Map(t)}_integrate(t,e){super._integrate(t,e),this._prelimContent.forEach((t,e)=>{this.set(e,t)}),this._prelimContent=null}clone(){const t=this._copy();return this.forEach((e,n)=>{t.set(n,e instanceof Ui?e.clone():e)}),t}toJSON(){this.doc??Di();const t={};return this._map.forEach((e,n)=>{if(!e.deleted){const s=e.content.getContent()[e.length-1];t[n]=s instanceof Ui?s.toJSON():s}}),t}get size(){return[...qi(this)].length}keys(){return Ei(qi(this),t=>t[0])}values(){return Ei(qi(this),t=>t[1].content.getContent()[t[1].length-1])}entries(){return Ei(qi(this),t=>[t[0],t[1].content.getContent()[t[1].length-1]])}forEach(t){this.doc??Di(),this._map.forEach((e,n)=>{e.deleted||t(e.content.getContent()[e.length-1],n,this)})}[Symbol.iterator](){return this.entries()}delete(t){null!==this.doc?Gs(this.doc,e=>{Hi(e,this,t)}):this._prelimContent.delete(t)}set(t,e){return null!==this.doc?Gs(this.doc,n=>{$i(n,this,t,e)}):this._prelimContent.set(t,e),e}get(t){return Wi(this,t)}has(t){return Gi(this,t)}clear(){null!==this.doc?Gs(this.doc,t=>{this.forEach(function(e,n,s){Hi(t,s,n)})}):this._prelimContent.clear()}_write(t){t.writeTypeRef(Uo)}}class to{constructor(t,e,n,s,r){this.left=t,this.right=e,this.index=n,this.currentAttributes=s,this.am=r}forward(){if(null===this.right&&et(),this.right.content.constructor===Eo)this.right.deleted||ro(this.currentAttributes,this.right.content);else this.index+=this.am.contentLength(this.right);this.left=this.right,this.right=this.right.right}formatText(t,e,n,s){const r=t.doc,i=r.clientID;io(this,s);const o=oo(t,e,this,s);t:for(;null!==this.right&&(n>0||o.size>0&&(this.right.deleted&&0===this.am.contentLength(this.right)||this.right.content.constructor===Eo));){switch(this.right.content.constructor){case Eo:if(!this.right.deleted){const{key:e,value:r}=this.right.content,i=s[e];if(void 0!==i){if(Mi(i,r))o.delete(e);else{if(0===n)break t;o.set(e,r)}this.right.delete(t)}else this.currentAttributes.set(e,r)}break;default:{const e=this.right,s=this.am.contentLength(e);if(n<s){const s=[];this.am.readContent(s,e.id.client,e.id.clock,e.deleted,e.content,0);let r=0;for(;r<s.length&&n>0;r++){const t=s[r];t.deleted&&null==t.attrs||!t.content.isCountable()||(n-=t.content.getLength())}if(n<0||0===n&&r!==s.length){const i=s[--r];Sn(t,tn(e.id.client,i.clock+i.content.getLength()+n))}}else n-=s;break}}this.forward()}if(n>0){let s="";for(;n>0;n--)s+="\n";this.right=new $o(tn(i,wn(r.store,i)),this.left,this.left&&this.left.lastId,this.right,this.right&&this.right.id,e,null,new xo(s)),this.right.integrate(t,0),this.forward()}so(t,e,this,o)}}const eo=(t,e,n)=>{for(;null!==e.right&&n>0;){if(e.right.content.constructor===Eo)e.right.deleted||ro(e.currentAttributes,e.right.content);else e.right.deleted||(n<e.right.length&&Sn(t,tn(e.right.id.client,e.right.id.clock+n)),e.index+=e.right.length,n-=e.right.length);e.left=e.right,e.right=e.right.right}return e},no=(t,e,n,s)=>{const r=new Map,i=s?Li(e,n):null;if(i){const e=new to(i.p.left,i.p,i.index,r,bi);return eo(t,e,n-i.index)}{const s=new to(null,e._start,0,r,bi);return eo(t,s,n)}},so=(t,e,n,s)=>{for(;null!==n.right&&(n.right.deleted&&(n.am===bi||0===n.am.contentLength(n.right))||n.right.content.constructor===Eo&&Mi(s.get(n.right.content.key),n.right.content.value));)n.right.deleted||s.delete(n.right.content.key),n.forward();const r=t.doc,i=r.clientID;s.forEach((s,o)=>{const l=n.left,c=n.right,h=new $o(tn(i,wn(r.store,i)),l,l&&l.lastId,c,c&&c.id,e,null,new Eo(o,s));h.integrate(t,0),n.right=h,n.forward()})},ro=(t,e)=>{const{key:n,value:s}=e;null===s?t.delete(n):t.set(n,s)},io=(t,e)=>{for(;null!==t.right&&(t.right.deleted?0===t.am.contentLength(t.right):!t.right.deleted&&t.right.content.constructor===Eo&&Mi(e[t.right.content.key]??null,t.right.content.value));)t.forward()},oo=(t,e,n,s)=>{const r=t.doc,i=r.clientID,o=new Map;for(const l in s){const c=s[l],h=n.currentAttributes.get(l)??null;if(!Mi(h,c)){o.set(l,h);const{left:s,right:a}=n;n.right=new $o(tn(i,wn(r.store,i)),s,s&&s.lastId,a,a&&a.id,e,null,new Eo(l,c)),n.right.integrate(t,0),n.forward()}}return o},lo=(t,e,n,s,r)=>{n.currentAttributes.forEach((t,e)=>{void 0===r[e]&&(r[e]=null)});const i=t.doc,o=i.clientID;io(n,r);const l=oo(t,e,n,r),c=s.constructor===String?new xo(s):s instanceof Ui?new Fo(s):new vo(s);let{left:h,right:a,index:u}=n;e._searchMarker&&Oi(e._searchMarker,n.index,c.getLength()),a=new $o(tn(o,wn(i.store,o)),h,h&&h.lastId,a,a&&a.id,e,null,c),a.integrate(t,0),n.right=a,n.index=u,n.forward(),so(t,e,n,l)},co=(t,n,s,r,i)=>{if(!t.doc.cleanupFormatting)return 0;let o=n;const l=e();for(;o&&(!o.countable||o.deleted);){if(!o.deleted&&o.content.constructor===Eo){const t=o.content;l.set(t.key,t)}o=o.right}let c=0,h=!1;for(;n!==o;){if(s===n&&(h=!0),!n.deleted){const e=n.content;switch(e.constructor){case Eo:{const{key:s,value:o}=e,a=r.get(s)??null;l.get(s)===e&&a!==o||(n.delete(t),t.cleanUps.add(n.id.client,n.id.clock,n.length),c++,h||(i.get(s)??null)!==o||a===o||(null===a?i.delete(s):i.set(s,a))),h||n.deleted||ro(i,e);break}}}n=n.right}return c},ho=t=>{if(!t.doc?.cleanupFormatting)return 0;let s=0;return Gs(t.doc,r=>{let i=t._start,o=t._start,l=e();const c=n(l);for(;o;){if(!1===o.deleted)if(o.content.constructor===Eo)ro(c,o.content);else s+=co(r,i,o,l,c),l=n(c),i=o;o=o.right}}),s},ao=t=>{const e=new Set,n=t.doc;It(t,t.insertSet,t=>{t.deleted||t.content.constructor!==Eo||t.constructor===yo||e.add(t.parent)}),Gs(n,n=>{It(t,t.deleteSet,t=>{if(t instanceof yo||!t.parent._hasFormatting||e.has(t.parent))return;const s=t.parent;t.content.constructor===Eo?e.add(s):((t,e)=>{if(!t.doc.cleanupFormatting)return 0;for(;e&&e.right&&(e.right.deleted||!e.right.countable);)e=e.right;const n=new Set;for(;e&&(e.deleted||!e.countable);){if(!e.deleted&&e.content.constructor===Eo){const s=e.content.key;n.has(s)?(e.delete(t),t.cleanUps.add(e.id.client,e.id.clock,e.length)):n.add(s)}e=e.left}})(n,t)});for(const t of e)ho(t)})},uo=(t,e,r)=>{const i=r,o=n(e.currentAttributes),l=e.right;for(;r>0&&null!==e.right;){if(e.right.deleted){if(e.am!==bi){const n=e.right,i=[];e.am.readContent(i,n.id.client,n.id.clock,!0,n.content,0);for(let e=0;e<i.length;e++){const o=i[e];if(o.content.isCountable()&&null!=o.attrs){const e=p(o.content.getLength(),r);s(t.meta,"attributedDeletes",Ft).add(n.id.client,o.clock,e),r-=e}}const o=i.length>0?i[i.length-1]:null,l=n.id.clock+n.length,c=null!=o?o.clock+o.content.getLength():l;c<l&&Sn(t,tn(n.id.client,c))}}else switch(e.right.content.constructor){case Fo:case vo:case xo:r<e.right.length&&Sn(t,tn(e.right.id.client,e.right.id.clock+r)),r-=e.right.length,e.right.delete(t)}e.forward()}l&&co(t,l,e.right,o,e.currentAttributes);const c=(e.left||e.right).parent;return c._searchMarker&&Oi(c._searchMarker,e.index,-i+r),e};class go extends Ui{constructor(t){super(),this._pending=void 0!==t?[()=>this.insert(0,t)]:[],this._searchMarker=[],this._hasFormatting=!1}get length(){return this.doc??Di(),this._length}_integrate(t,e){super._integrate(t,e);try{this._pending.forEach(t=>t())}catch(t){console.error(t)}this._pending=null}clone(){const t=new go;return t.applyDelta(this.getContent()),t}_callObserver(t,e){super._callObserver(t,e),!t.local&&this._hasFormatting&&(t._needFormattingCleanup=!0)}toString(){this.doc??Di();let t="",e=this._start;for(;null!==e;)!e.deleted&&e.countable&&e.content.constructor===xo&&(t+=e.content.str),e=e.right;return t}toJSON(){return this.toString()}insert(t,e,n){if(e.length<=0)return;const s=this.doc;null!==s?Gs(s,s=>{const r=no(s,this,t,!n);n||(n={},r.currentAttributes.forEach((t,e)=>{n[e]=t})),lo(s,this,r,e,n)}):this._pending.push(()=>this.insert(t,e,n))}insertEmbed(t,e,n){const s=this.doc;null!==s?Gs(s,s=>{const r=no(s,this,t,!n);lo(s,this,r,e,n||{})}):this._pending.push(()=>this.insertEmbed(t,e,n||{}))}delete(t,e){if(0===e)return;const n=this.doc;null!==n?Gs(n,n=>{uo(n,no(n,this,t,!0),e)}):this._pending.push(()=>this.delete(t,e))}format(t,e,n){if(0===e)return;const s=this.doc;null!==s?Gs(s,s=>{const r=no(s,this,t,!1);null!==r.right&&r.formatText(s,this,e,n)}):this._pending.push(()=>this.format(t,e,n))}removeAttribute(t){null!==this.doc?Gs(this.doc,e=>{Hi(e,this,t)}):this._pending.push(()=>this.removeAttribute(t))}setAttribute(t,e){null!==this.doc?Gs(this.doc,n=>{$i(n,this,t,e)}):this._pending.push(()=>this.setAttribute(t,e))}getAttribute(t){return Wi(this,t)}getAttributes(){return Ki(this)}_write(t){t.writeTypeRef(Mo)}[yt](t){return this.getContent().equals(t.getContent())}}class fo extends Ui{constructor(){super(),this._prelimContent=[]}get firstChild(){const t=this._first;return t?t.content.getContent()[0]:null}_integrate(t,e){super._integrate(t,e),this.insert(0,this._prelimContent),this._prelimContent=null}clone(){const t=this._copy();return t.insert(0,this.toArray().map(t=>t instanceof Ui?t.clone():t)),t}get length(){return this.doc??Di(),null===this._prelimContent?this._length:this._prelimContent.length}toString(){return Vi(this,t=>t.toString()).join("")}toJSON(){return this.toString()}insert(t,e){null!==this.doc?Gs(this.doc,n=>{zi(n,this,t,e)}):this._prelimContent.splice(t,0,...e)}insertAfter(t,e){if(null!==this.doc)Gs(this.doc,n=>{const s=t&&t instanceof Ui?t._item:t;ji(n,this,s,e)});else{const n=this._prelimContent,s=null===t?0:n.findIndex(e=>e===t)+1;if(0===s&&null!==t)throw Q("Reference item not found");n.splice(s,0,...e)}}delete(t,e=1){null!==this.doc?Gs(this.doc,n=>{Bi(n,this,t,e)}):this._prelimContent.splice(t,e)}toArray(){return Ni(this)}push(t){this.insert(this.length,t)}unshift(t){this.insert(0,t)}get(t){return Pi(this,t)}slice(t=0,e=this.length){return Ti(this,t,e)}forEach(t){Ri(this,t)}_write(t){t.writeTypeRef(No)}}class po extends fo{constructor(t="UNDEFINED"){super(),this.nodeName=t,this._prelimAttrs=new Map}get nextSibling(){const t=this._item?this._item.next:null;return t?t.content.type:null}get prevSibling(){const t=this._item?this._item.prev:null;return t?t.content.type:null}_integrate(t,e){super._integrate(t,e),this._prelimAttrs.forEach((t,e)=>{this.setAttribute(e,t)}),this._prelimAttrs=null}_copy(){return new po(this.nodeName)}clone(){const t=this._copy();return((t,e)=>{for(const n in t)e(t[n],n)})(this.getAttributes(),(e,n)=>{"string"==typeof e&&t.setAttribute(n,e)}),t.insert(0,this.toArray().map(t=>t instanceof Ui?t.clone():t)),t}toString(){const t=this.getAttributes(),e=[],n=[];for(const e in t)n.push(e);n.sort();const s=n.length;for(let r=0;r<s;r++){const s=n[r];e.push(s+'="'+t[s]+'"')}const r=this.nodeName.toLocaleLowerCase();return`<${r}${e.length>0?" "+e.join(" "):""}>${super.toString()}</${r}>`}removeAttribute(t){null!==this.doc?Gs(this.doc,e=>{Hi(e,this,t)}):this._prelimAttrs.delete(t)}setAttribute(t,e){null!==this.doc?Gs(this.doc,n=>{$i(n,this,t,e)}):this._prelimAttrs.set(t,e)}getAttribute(t){return Wi(this,t)}hasAttribute(t){return Gi(this,t)}getAttributes(t){return t?Xi(this,t):Ki(this)}_write(t){t.writeTypeRef(To),t.writeKey(this.nodeName)}}class ko extends Qi{constructor(t){super(),this.hookName=t}_copy(){return new ko(this.hookName)}clone(){const t=this._copy();return this.forEach((e,n)=>{t.set(n,e)}),t}_write(t){t.writeTypeRef(Ro),t.writeKey(this.hookName)}}class wo extends go{get nextSibling(){const t=this._item?this._item.next:null;return t?t.content.type:null}get prevSibling(){const t=this._item?this._item.prev:null;return t?t.content.type:null}clone(){const t=this._copy();return t.applyDelta(this.getContent()),t}toJSON(){return this.toString()}_write(t){t.writeTypeRef(Vo)}}class mo{constructor(t,e){this.id=t,this.length=e}get deleted(){throw tt()}mergeWith(t){return!1}write(t,e,n){throw tt()}integrate(t,e){throw tt()}splice(t){throw tt()}}class yo extends mo{get deleted(){return!0}delete(){}mergeWith(t){return this.constructor===t.constructor&&(this.length+=t.length,!0)}integrate(t,e){e>0&&(this.id.clock+=e,this.length-=e),Rt(t.deleteSet,this.id.client,this.id.clock,this.length),Vt(t.insertSet,this),mn(t.doc.store,this)}write(t,e,n){t.writeInfo(0),t.writeLen(this.length-e-n)}getMissing(t,e){return null}splice(t){const e=new yo(tn(this.id.client,this.id.clock+t),this.length-t);return this.length=t,e}}class bo{constructor(t){this.content=t}getLength(){return 1}getContent(){return[this.content]}isCountable(){return!0}copy(){return new bo(this.content)}splice(t){throw tt()}mergeWith(t){return!1}integrate(t,e){}delete(t){}gc(t){}write(t,e,n){t.writeBuf(this.content)}getRef(){return 3}}class _o{constructor(t){this.len=t}getLength(){return this.len}getContent(){return[]}isCountable(){return!1}copy(){return new _o(this.len)}splice(t){const e=new _o(this.len-t);return this.len=t,e}mergeWith(t){return this.len+=t.len,!0}integrate(t,e){Rt(t.deleteSet,e.id.client,e.id.clock,this.len),e.markDeleted()}delete(t){}gc(t){}write(t,e,n){t.writeLen(this.len-e-n)}getRef(){return 1}}const So=(t,e)=>new Zt({guid:t,...e,shouldLoad:e.shouldLoad||e.autoLoad||!1});class Co{constructor(t){t._item&&console.error("This document was already integrated as a sub-document. You should create a second instance instead with the same guid."),this.doc=t;const e={};this.opts=e,t.gc||(e.gc=!1),t.autoLoad&&(e.autoLoad=!0),null!==t.meta&&(e.meta=t.meta)}getLength(){return 1}getContent(){return[this.doc]}isCountable(){return!0}copy(){return new Co(So(this.doc.guid,this.opts))}splice(t){throw tt()}mergeWith(t){return!1}integrate(t,e){this.doc._item=e,t.subdocsAdded.add(this.doc),this.doc.shouldLoad&&t.subdocsLoaded.add(this.doc)}delete(t){t.subdocsAdded.has(this.doc)?t.subdocsAdded.delete(this.doc):t.subdocsRemoved.add(this.doc)}gc(t){}write(t,e,n){t.writeString(this.doc.guid),t.writeAny(this.opts)}getRef(){return 9}}class vo{constructor(t){this.embed=t}getLength(){return 1}getContent(){return[this.embed]}isCountable(){return!0}copy(){return new vo(this.embed)}splice(t){throw tt()}mergeWith(t){return!1}integrate(t,e){}delete(t){}gc(t){}write(t,e,n){t.writeJSON(this.embed)}getRef(){return 5}}class Eo{constructor(t,e){this.key=t,this.value=e}getLength(){return 1}getContent(){return[]}isCountable(){return!1}copy(){return new Eo(this.key,this.value)}splice(t){throw tt()}mergeWith(t){return!1}integrate(t,e){const n=e.parent;n._searchMarker=null,n._hasFormatting=!0}delete(t){}gc(t){}write(t,e,n){t.writeKey(this.key),t.writeJSON(this.value)}getRef(){return 6}}class Do{constructor(t){this.arr=t}getLength(){return this.arr.length}getContent(){return this.arr}isCountable(){return!0}copy(){return new Do(this.arr)}splice(t){const e=new Do(this.arr.slice(t));return this.arr=this.arr.slice(0,t),e}mergeWith(t){return this.arr=this.arr.concat(t.arr),!0}integrate(t,e){}delete(t){}gc(t){}write(t,e,n){const s=this.arr.length-n;t.writeLen(s-e);for(let n=e;n<s;n++){const e=this.arr[n];t.writeString(void 0===e?"undefined":JSON.stringify(e))}}getRef(){return 2}}const Io="development"===ye("node_env");class Ao{constructor(t){this.arr=t,Io&&ue(t)}getLength(){return this.arr.length}getContent(){return this.arr}isCountable(){return!0}copy(){return new Ao(this.arr)}splice(t){const e=new Ao(this.arr.slice(t));return this.arr=this.arr.slice(0,t),e}mergeWith(t){return this.arr=this.arr.concat(t.arr),!0}integrate(t,e){}delete(t){}gc(t){}write(t,e,n){const s=this.arr.length-n;t.writeLen(s-e);for(let n=e;n<s;n++){const e=this.arr[n];t.writeAny(e)}}getRef(){return 8}}class xo{constructor(t){this.str=t}getLength(){return this.str.length}getContent(){return this.str.split("")}isCountable(){return!0}copy(){return new xo(this.str)}splice(t){const e=new xo(this.str.slice(t));this.str=this.str.slice(0,t);const n=this.str.charCodeAt(t-1);return n>=55296&&n<=56319&&(this.str=this.str.slice(0,t-1)+"",e.str=""+e.str.slice(1)),e}mergeWith(t){return this.str+=t.str,!0}integrate(t,e){}delete(t){}gc(t){}write(t,e,n){t.writeString(0===e&&0===n?this.str:this.str.slice(e,this.str.length-n))}getRef(){return 4}}const Lo=[t=>new Zi,t=>new Qi,t=>new go,t=>new po(t.readKey()),t=>new fo,t=>new ko(t.readKey()),t=>new wo],Oo=0,Uo=1,Mo=2,To=3,No=4,Ro=5,Vo=6;class Fo{constructor(t){this.type=t}getLength(){return 1}getContent(){return[this.type]}isCountable(){return!0}copy(){return new Fo(this.type._copy())}splice(t){throw tt()}mergeWith(t){return!1}integrate(t,e){this.type._integrate(t.doc,e)}delete(t){let e=this.type._start;for(;null!==e;)e.deleted?t.insertSet.hasId(e.id)||t._mergeStructs.push(e):e.delete(t),e=e.right;this.type._map.forEach(e=>{e.deleted?t.insertSet.hasId(e.id)||t._mergeStructs.push(e):e.delete(t)}),t.changed.delete(this.type)}gc(t){let e=this.type._start;for(;null!==e;)e.gc(t,!0),e=e.right;this.type._start=null,this.type._map.forEach(e=>{for(;null!==e;)e.gc(t,!0),e=e.left}),this.type._map=new Map}write(t,e,n){this.type._write(t)}getRef(){return 7}}const Po=(t,e)=>{let n,s=e,r=0;do{r>0&&(s=tn(s.client,s.clock+r)),n=bn(t,s),r=s.clock-n.id.clock,s=n.redone}while(null!==s&&n instanceof $o);return{item:n,diff:r}},jo=(t,e)=>{for(;null!==t&&t.keep!==e;)t.keep=e,t=t.parent._item},Jo=(t,e,n)=>{const{client:s,clock:r}=e.id,i=new $o(tn(s,r+n),e,tn(s,r+n-1),e.right,e.rightOrigin,e.parent,e.parentSub,e.content.splice(n));return e.deleted&&i.markDeleted(),e.keep&&(i.keep=!0),null!==e.redone&&(i.redone=tn(e.redone.client,e.redone.clock+n)),null!=t?(e.right=i,null!==i.right&&(i.right.left=i),t._mergeStructs.push(i),null!==i.parentSub&&null===i.right&&i.parent._map.set(i.parentSub,i)):(i.left=null,i.right=null),e.length=n,i},zo=(t,e,n)=>{if(e instanceof $o)return Jo(t,e,n);{const s=e.splice(n);return t?._mergeStructs.push(s),s}},Bo=(t,e)=>h(t,t=>t.deletions.hasId(e)),Ho=(t,e,n,s,r,i)=>{const o=t.doc,l=o.store,c=o.clientID,h=e.redone;if(null!==h)return Sn(t,h);let a,u=e.parent._item,d=null;if(null!==u&&!0===u.deleted){if(null===u.redone&&(!n.has(u)||null===Ho(t,u,n,s,r,i)))return null;for(;null!==u.redone;)u=Sn(t,u.redone)}const g=null===u?e.parent:u.content.type;if(null===e.parentSub){for(d=e.left,a=e;null!==d;){let e=d;for(;null!==e&&e.parent._item!==u;)e=null===e.redone?null:Sn(t,e.redone);if(null!==e&&e.parent._item===u){d=e;break}d=d.left}for(;null!==a;){let e=a;for(;null!==e&&e.parent._item!==u;)e=null===e.redone?null:Sn(t,e.redone);if(null!==e&&e.parent._item===u){a=e;break}a=a.right}}else if(a=null,e.right&&!r){for(d=e;null!==d&&null!==d.right&&(d.right.redone||s.hasId(d.right.id)||Bo(i.undoStack,d.right.id)||Bo(i.redoStack,d.right.id));)for(d=d.right;d.redone;)d=Sn(t,d.redone);if(d&&null!==d.right)return null}else d=g._map.get(e.parentSub)||null;const f=wn(l,c),p=tn(c,f),k=new $o(p,d,d&&d.lastId,a,a&&a.id,g,e.parentSub,e.content.copy());return e.redone=p,jo(k,!0),k.integrate(t,0),k};class $o extends mo{constructor(t,e,n,s,r,i,o,l){super(t,l.getLength()),this.origin=n,this.left=e,this.right=s,this.rightOrigin=r,this.parent=i,this.parentSub=o,this.redone=null,this.content=l,this.info=this.content.isCountable()?2:0}set marker(t){(8&this.info)>0!==t&&(this.info^=8)}get marker(){return(8&this.info)>0}get keep(){return(1&this.info)>0}set keep(t){this.keep!==t&&(this.info^=1)}get countable(){return(2&this.info)>0}get deleted(){return(4&this.info)>0}set deleted(t){this.deleted!==t&&(this.info^=4)}markDeleted(){this.info|=4}getMissing(t,e){if(this.origin&&(this.origin.clock>=wn(e,this.origin.client)||e.skips.hasId(this.origin)))return this.origin.client;if(this.rightOrigin&&(this.rightOrigin.clock>=wn(e,this.rightOrigin.client)||e.skips.hasId(this.rightOrigin)))return this.rightOrigin.client;if(this.parent&&this.parent.constructor===Ze&&(this.parent.clock>=wn(e,this.parent.client)||e.skips.hasId(this.parent)))return this.parent.client;if(this.origin&&(this.left=Cn(t,e,this.origin),this.origin=this.left.lastId),this.rightOrigin&&(this.right=Sn(t,this.rightOrigin),this.rightOrigin=this.right.id),this.left&&this.left.constructor===yo||this.right&&this.right.constructor===yo)this.parent=null;else if(this.parent){if(this.parent.constructor===Ze){const t=bn(e,this.parent);t.constructor===yo?this.parent=null:this.parent=t.content.type}}else this.left&&this.left.constructor===$o?(this.parent=this.left.parent,this.parentSub=this.left.parentSub):this.right&&this.right.constructor===$o&&(this.parent=this.right.parent,this.parentSub=this.right.parentSub);return null}integrate(t,e){if(e>0&&(this.id.clock+=e,this.left=Cn(t,t.doc.store,tn(this.id.client,this.id.clock-1)),this.origin=this.left.lastId,this.content=this.content.splice(e),this.length-=e),this.parent){if(!this.left&&(!this.right||null!==this.right.left)||this.left&&this.left.right!==this.right){let e,n=this.left;if(null!==n)e=n.right;else if(null!==this.parentSub)for(e=this.parent._map.get(this.parentSub)||null;null!==e&&null!==e.left;)e=e.left;else e=this.parent._start;const s=new Set,r=new Set;for(;null!==e&&e!==this.right;){if(r.add(e),s.add(e),Qe(this.origin,e.origin)){if(e.id.client<this.id.client)n=e,s.clear();else if(Qe(this.rightOrigin,e.rightOrigin))break}else{if(null===e.origin||!r.has(bn(t.doc.store,e.origin)))break;s.has(bn(t.doc.store,e.origin))||(n=e,s.clear())}e=e.right}this.left=n}if(null!==this.left){const t=this.left.right;this.right=t,this.left.right=this}else{let t;if(null!==this.parentSub)for(t=this.parent._map.get(this.parentSub)||null;null!==t&&null!==t.left;)t=t.left;else t=this.parent._start,this.parent._start=this;this.right=t}null!==this.right?this.right.left=this:null!==this.parentSub&&(this.parent._map.set(this.parentSub,this),null!==this.left&&this.left.delete(t)),null===this.parentSub&&this.countable&&!this.deleted&&(this.parent._length+=this.length),Vt(t.insertSet,this),mn(t.doc.store,this),this.content.integrate(t,this),Hs(t,this.parent,this.parentSub),(null!==this.parent._item&&this.parent._item.deleted||null!==this.parentSub&&null!==this.right)&&this.delete(t)}else new yo(this.id,this.length).integrate(t,0)}get next(){let t=this.right;for(;null!==t&&t.deleted;)t=t.right;return t}get prev(){let t=this.left;for(;null!==t&&t.deleted;)t=t.left;return t}get lastId(){return 1===this.length?this.id:tn(this.id.client,this.id.clock+this.length-1)}mergeWith(t){if(this.constructor===t.constructor&&Qe(t.origin,this.lastId)&&this.right===t&&Qe(this.rightOrigin,t.rightOrigin)&&this.id.client===t.id.client&&this.id.clock+this.length===t.id.clock&&this.deleted===t.deleted&&null===this.redone&&null===t.redone&&this.content.constructor===t.content.constructor&&this.content.mergeWith(t.content)){const e=this.parent._searchMarker;return e&&e.forEach(e=>{e.p===t&&(e.p=this,!this.deleted&&this.countable&&(e.index-=this.length))}),t.keep&&(this.keep=!0),this.right=t.right,null!==this.right&&(this.right.left=this),this.length+=t.length,!0}return!1}delete(t){if(!this.deleted){const e=this.parent;this.countable&&null===this.parentSub&&(e._length-=this.length),this.markDeleted(),Rt(t.deleteSet,this.id.client,this.id.clock,this.length),Hs(t,e,this.parentSub),this.content.delete(t)}}gc(t,e){if(!this.deleted)throw et();this.content.gc(t),e?((t,e,n)=>{const s=t.doc.store.clients.get(e.id.client);s[yn(s,e.id.clock)]=n,t._mergeStructs.push(n)})(t,this,new yo(this.id,this.length)):this.content=new _o(this.length)}write(t,e,n){const s=e>0?tn(this.id.client,this.id.clock+e-1):this.origin,r=this.rightOrigin,i=this.parentSub,o=31&this.content.getRef()|(null===s?0:y)|(null===r?0:m)|(null===i?0:32);if(t.writeInfo(o),null!==s&&t.writeLeftID(s),null!==r&&t.writeRightID(r),null===s&&null===r){const e=this.parent;if(void 0!==e._item){const n=e._item;if(null===n){const n=sn(e);t.writeParentInfo(!0),t.writeString(n)}else t.writeParentInfo(!1),t.writeLeftID(n.id)}else e.constructor===String?(t.writeParentInfo(!0),t.writeString(e)):e.constructor===Ze?(t.writeParentInfo(!1),t.writeLeftID(e)):et();null!==i&&t.writeString(i)}this.content.write(t,e,n)}}const Wo=(t,e)=>Ko[31&e](t),Ko=[()=>{et()},t=>new _o(t.readLen()),t=>{const e=t.readLen(),n=[];for(let s=0;s<e;s++){const e=t.readString();"undefined"===e?n.push(void 0):n.push(JSON.parse(e))}return new Do(n)},t=>new bo(t.readBuf()),t=>new xo(t.readString()),t=>new vo(t.readJSON()),t=>new Eo(t.readKey(),t.readJSON()),t=>new Fo(Lo[t.readTypeRef()](t)),t=>{const e=t.readLen(),n=[];for(let s=0;s<e;s++)n.push(t.readAny());return new Ao(n)},t=>new Co(So(t.readString(),t.readAny())),()=>{et()}];class Yo extends mo{get deleted(){return!1}delete(){}mergeWith(t){return this.constructor===t.constructor&&(this.length+=t.length,!0)}integrate(t,e){e>0&&(this.id.clock+=e,this.length-=e),Rt(t.doc.store.skips,this.id.client,this.id.clock,this.length),mn(t.doc.store,this)}write(t,e){t.writeInfo(10),V(t.restEncoder,this.length-e)}getMissing(t,e){return null}splice(t){const e=new Yo(tn(this.id.client,this.id.clock+t),this.length-t);return this.length=t,e}}const Go="undefined"!=typeof globalThis?globalThis:"undefined"!=typeof window?window:"undefined"!=typeof global?global:{},Xo="__ $YJS$ __";!0===Go[Xo]&&console.error("Yjs was already imported. This breaks constructor checks and will lead to issues! - https://github.com/yjs/yjs/issues/438"),Go[Xo]=!0,t.AbsolutePosition=ln,t.AbstractAttributionManager=class extends d{readContent(t,e,n,s,r,i){tt()}contentLength(t){tt()}},t.AbstractConnector=class extends d{constructor(t,e){super(),this.doc=t,this.awareness=e}},t.AbstractStruct=mo,t.AbstractType=Ui,t.Array=Zi,t.Attribution=ri,t.ContentAny=Ao,t.ContentBinary=bo,t.ContentDeleted=_o,t.ContentDoc=Co,t.ContentEmbed=vo,t.ContentFormat=Eo,t.ContentJSON=Do,t.ContentString=xo,t.ContentType=Fo,t.DiffAttributionManager=Ci,t.Doc=Zt,t.GC=yo,t.ID=Ze,t.IdMap=di,t.IdSet=Et,t.Item=$o,t.Map=Qi,t.RelativePosition=on,t.Skip=Yo,t.Snapshot=hn,t.Text=go,t.Transaction=zs,t.TwosetAttributionManager=class extends d{constructor(t,e){super(),this.inserts=t,this.deletes=e}readContent(t,e,n,s,r,i){const o=(s?this.deletes:this.inserts).slice(e,n,r.getLength());r=1===o.length?r:r.copy(),o.forEach(e=>{const n=r;e.len<n.getLength()&&(r=n.splice(e.len)),s&&null==e.attrs&&!i||t.push(new yi(n,e.clock,s,e.attrs,i))})}contentLength(t){return t.content.isCountable()?t.deleted?this.deletes.sliceId(t.id,t.length).reduce((t,e)=>null!=e.attrs?t+e.len:t,0):t.length:0}},t.UndoManager=Qs,t.UpdateDecoderV1=Ae,t.UpdateDecoderV2=Le,t.UpdateEncoderV1=Ue,t.UpdateEncoderV2=Te,t.XmlElement=po,t.XmlFragment=fo,t.XmlHook=ko,t.XmlText=wo,t.YEvent=Zr,t.applyUpdate=je,t.applyUpdateV2=Pe,t.cleanupYTextFormatting=ho,t.cloneDoc=(t,e)=>{const n=new Zt(e);return je(n,ze(t)),n},t.compareIDs=Qe,t.compareRelativePositions=(t,e)=>t===e||null!==t&&null!==e&&t.tname===e.tname&&Qe(t.item,e.item)&&Qe(t.type,e.type)&&t.assoc===e.assoc,t.convertUpdateFormatV1ToV2=t=>gr(t,ge,Ae,Te),t.convertUpdateFormatV2ToV1=pr,t.createAbsolutePositionFromRelativePosition=(t,e,n=!0,s=bi)=>{const r=e.store,i=t.item,o=t.type,l=t.tname,c=t.assoc;let h=null,a=0;if(null!==i){if(wn(r,i.client)<=i.clock)return null;const t=n?Po(r,i):((t,e)=>{const n=bn(t,e);return{item:n,diff:e.clock-n.id.clock}})(r,i),e=t.item;if(!(e instanceof $o))return null;if(h=e.parent,null===h._item||!h._item.deleted){a=0===s.contentLength(e)?0:t.diff+(c>=0?0:1);let n=e.left;for(;null!==n;)a+=s.contentLength(n),n=n.left}}else{if(null!==l)h=e.get(l);else{if(null===o)throw et();{if(wn(r,o.client)<=o.clock)return null;const{item:t}=n?Po(r,o):{item:bn(r,o)};if(!(t instanceof $o&&t.content instanceof Fo))return null;h=t.content.type}}a=c>=0?h._length:0}return((t,e,n=0)=>new ln(t,e,n))(h,a,t.assoc)},t.createAttributionItem=(t,e)=>new ri(t,e),t.createAttributionManagerFromDiff=(t,e)=>new Ci(t,e),t.createDeleteSetFromStructStore=Pt,t.createDocFromSnapshot=(t,e,n=new Zt)=>{if(t.gc)throw new Error("Garbage-collection must be disabled in `originDoc`!");const{sv:s,ds:r}=e,i=new Te;return t.transact(e=>{let n=0;s.forEach(t=>{t>0&&n++}),V(i.restEncoder,n);for(const[n,r]of s){if(0===r)continue;r<wn(t.store,n)&&Sn(e,tn(n,r));const s=t.store.clients.get(n)||[],o=yn(s,r-1);V(i.restEncoder,o+1),i.writeClient(n),V(i.restEncoder,0);for(let t=0;t<=o;t++)s[t].write(i,0,0)}Jt(i,r)}),Pe(n,i.toUint8Array(),"snapshot"),n},t.createID=tn,t.createIdMap=pi,t.createIdMapFromIdSet=ui,t.createIdSet=Ft,t.createInsertionSetFromStructStore=jt,t.createRelativePositionFromJSON=t=>new on(null==t.type?null:tn(t.type.client,t.type.clock),t.tname??null,null==t.item?null:tn(t.item.client,t.item.clock),null==t.assoc?0:t.assoc),t.createRelativePositionFromTypeIndex=(t,e,n=0,s=bi)=>{let r=t._start;if(n<0){if(0===e)return cn(t,null,n);e--}for(;null!==r;){const i=s.contentLength(r);if(i>e)return cn(t,tn(r.id.client,r.id.clock+e),n);if(e-=i,null===r.right&&n<0)return cn(t,r.lastId,n);r=r.right}return cn(t,null,n)},t.createSnapshot=dn,t.decodeIdMap=t=>gi(new xe(it(t))),t.decodeRelativePosition=t=>(t=>{let e=null,n=null,s=null;switch(ht(t)){case 0:s=nn(t);break;case 1:n=ut(t);break;case 2:e=nn(t)}const r=ot(t)?at(t):0;return new on(e,n,s,r)})(it(t)),t.decodeSnapshot=t=>un(t,new Ie(it(t))),t.decodeSnapshotV2=un,t.decodeStateVector=He,t.decodeUpdate=t=>nr(t,Ae),t.decodeUpdateV2=nr,t.diffIdMap=wi,t.diffIdSet=Tt,t.diffUpdate=(t,e)=>hr(t,e,Ae,Ue),t.diffUpdateV2=hr,t.emptySnapshot=gn,t.encodeIdMap=t=>{const n=new Me;return((t,n)=>{V(t.restEncoder,n.clients.size);let s=0;const r=e(),i=e();l(n.clients.entries()).sort((t,e)=>t[0]-e[0]).forEach(([e,n])=>{const o=n.getIds();t.resetIdSetCurVal();const l=e-s;V(t.restEncoder,l),s=e;const c=o.length;V(t.restEncoder,c);for(let e=0;e<c;e++){const n=o[e],s=n.attrs,l=s.length;t.writeIdSetClock(n.clock),t.writeIdSetLen(n.len),V(t.restEncoder,l);for(let e=0;e<l;e++){const n=s[e],o=r.get(n);if(null!=o)V(t.restEncoder,o);else{const e=r.size;r.set(n,e),V(t.restEncoder,e);const s=i.get(n.name);if(null!=s)V(t.restEncoder,s);else{const e=i.size;V(t.restEncoder,e),J(t.restEncoder,n.name),i.set(n.name,e)}W(t.restEncoder,n.val)}}}})})(n,t),n.toUint8Array()},t.encodeRelativePosition=t=>{const e=U();return((t,e)=>{const{type:n,tname:s,item:r,assoc:i}=e;if(null!==r)V(t,0),en(t,r);else if(null!==s)R(t,1),J(t,s);else{if(null===n)throw et();R(t,2),en(t,n)}F(t,i)})(e,t),T(e)},t.encodeSnapshot=t=>an(t,new Oe),t.encodeSnapshotV2=an,t.encodeStateAsUpdate=ze,t.encodeStateAsUpdateV2=Je,t.encodeStateVector=t=>We(t,new Oe),t.encodeStateVectorFromUpdate=t=>ir(t,Oe,Ae),t.encodeStateVectorFromUpdateV2=ir,t.equalIdSets=Ht,t.equalSnapshots=(t,e)=>{const n=t.sv,s=e.sv;if(n.size!==s.size)return!1;for(const[t,e]of n.entries())if(s.get(t)!==e)return!1;return Ht(t.ds,e.ds)},t.findIndexSS=yn,t.findRootTypeKey=sn,t.getItem=bn,t.getItemCleanEnd=Cn,t.getItemCleanStart=Sn,t.getState=wn,t.getTypeChildren=t=>{t.doc??Di();let e=t._start;const n=[];for(;e;)n.push(e),e=e.right;return n},t.insertIntoIdMap=ki,t.insertIntoIdSet=Ut,t.isParentOf=rn,t.iterateStructsByIdSet=It,t.logType=t=>{const e=[];let n=t._start;for(;n;)e.push(n),n=n.right;console.log("Children: ",e),console.log("Children content: ",e.filter(t=>!t.deleted).map(t=>t.content))},t.logUpdate=t=>er(t,Ae),t.logUpdateV2=er,t.mergeIdMaps=t=>{const e=new Map,n=pi();for(let r=0;r<t.length;r++)t[r].clients.forEach((i,l)=>{if(!n.clients.has(l)){let c=i.getIds().slice();for(let e=r+1;e<t.length;e++){const n=t[e].clients.get(l);n&&o(c,n.getIds())}c=c.map(t=>new ci(t.clock,t.len,t.attrs.map(t=>s(e,t,()=>fi(n,[t])[0])))),n.clients.set(l,new ai(c))}});return n},t.mergeIdSets=Lt,t.mergeUpdates=rr,t.mergeUpdatesV2=cr,t.noAttributionsManager=bi,t.obfuscateUpdate=(t,e)=>gr(t,fr(e),Ae,Ue),t.obfuscateUpdateV2=(t,e)=>gr(t,fr(e),Le,Te),t.readIdMap=gi,t.readIdSet=zt,t.readUpdate=(t,e,n)=>Fe(t,e,n,new Ae(t)),t.readUpdateIdRanges=t=>or(t,Ae),t.readUpdateIdRangesV2=or,t.readUpdateV2=Fe,t.relativePositionToJSON=t=>{const e={};return t.type&&(e.type=t.type),t.tname&&(e.tname=t.tname),t.item&&(e.item=t.item),null!=t.assoc&&(e.assoc=t.assoc),e},t.snapshot=t=>dn(Pt(t.store),kn(t.store)),t.snapshotContainsUpdate=(t,e)=>((t,e,n=Le)=>{const s=new n(it(e)),r=new tr(s,!1);for(let e=r.curr;null!==e;e=r.next())if((t.sv.get(e.id.client)||0)<e.id.clock+e.length)return!1;const i=Lt([t.ds,zt(s)]);return Ht(t.ds,i)})(t,e,Ae),t.transact=Gs,t.tryGc=(t,e,n)=>{Ws(t,e,n),Ks(e,t.doc.store)},t.typeListToArraySnapshot=(t,e)=>{const n=[];let s=t._start;for(;null!==s;){if(s.countable&&fn(s,e)){const t=s.content.getContent();for(let e=0;e<t.length;e++)n.push(t[e])}s=s.right}return n},t.typeMapGetAllSnapshot=Xi,t.typeMapGetSnapshot=(t,e,n)=>{let s=t._map.get(e)||null;for(;null!==s&&(!n.sv.has(s.id.client)||s.id.clock>=(n.sv.get(s.id.client)||0));)s=s.left;return null!==s&&fn(s,n)?s.content.getContent()[s.length-1]:void 0}});
//# sourceMappingURL=yjs.umd.js.map
